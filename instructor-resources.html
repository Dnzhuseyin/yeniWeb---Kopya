<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaynak Yönetimi - Kriptarium Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#dc2626',
                        accent: '#059669',
                        cyber: '#6366f1',
                        dark: '#0f172a'
                    }
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ULTRA STRONG SIDEBAR FIX - NEVER DISAPPEAR */
        .sidebar-container {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            width: 256px !important;
            height: 100vh !important;
            z-index: 999999 !important;
            background-color: #0f172a !important;
            overflow-y: auto !important;
            transform: none !important;
            will-change: auto !important;
            pointer-events: auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .main-content {
            margin-left: 256px !important;
            z-index: 1 !important;
            position: relative !important;
        }
        
        /* Force sidebar to stay visible - ULTRA STRONG */
        body > aside {
            position: fixed !important;
            z-index: 999999 !important;
            left: 0 !important;
            top: 0 !important;
            height: 100vh !important;
            overflow-y: auto !important;
            transform: none !important;
            will-change: auto !important;
            pointer-events: auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Additional safety measures */
        aside.sidebar-container {
            position: fixed !important;
            z-index: 999999 !important;
            left: 0 !important;
            top: 0 !important;
            height: 100vh !important;
            overflow-y: auto !important;
            transform: none !important;
            will-change: auto !important;
            pointer-events: auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Sidebar - ULTRA STRONG FIXED - NEVER DISAPPEAR -->
    <aside class="sidebar-container bg-dark text-white w-64 min-h-screen hidden md:block">
        <div class="p-4">
            <a href="instructor-dashboard.html" class="font-bold text-xl text-secondary block mb-8 flex items-center">
                <i class="fas fa-key text-2xl mr-3"></i>
                Kriptarium Admin
            </a>
            
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div>
                        <p class="font-medium" id="instructor-name">Koordinatör</p>
                        <p class="text-sm text-gray-400" id="instructor-email">admin@kriptarium.com</p>
                    </div>
                </div>
            </div>
            
            <nav class="space-y-1">
                <a href="instructor-dashboard.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>Genel Bakış</span>
                </a>
                <a href="instructor-courses.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-graduation-cap mr-3"></i>
                    <span>Eğitim Modülleri</span>
                </a>
                <a href="instructor-content.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-video mr-3"></i>
                    <span>Video Yönetimi</span>
                </a>
                <a href="instructor-students.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-users mr-3"></i>
                    <span>Öğrenci Yönetimi</span>
                </a>
                <a href="instructor-resources.html" class="flex items-center px-4 py-3 rounded-lg bg-slate-800">
                    <i class="fas fa-download mr-3 text-secondary"></i>
                    <span>Kaynak Yönetimi</span>
                </a>
            </nav>

            <div class="absolute bottom-0 left-0 w-full p-4 border-t border-slate-800">
                <button onclick="logout()" class="flex items-center text-gray-400 hover:text-white w-full text-left bg-transparent border-none">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span>Çıkış Yap</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <main class="main-content p-4 md:p-8 w-full min-h-screen">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Kaynak Yönetimi</h1>
                        <p class="text-gray-600">Öğrenciler için indirilebilir kaynakları yönetin</p>
                    </div>
                    <button class="bg-cyber text-white px-4 py-2 rounded-lg flex items-center" id="add-resource-btn">
                        <i class="fas fa-plus mr-2"></i>
                        Yeni Kaynak Ekle
                    </button>
                </div>
            </header>

            <!-- Resource Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">Toplam Kaynak</h3>
                        <div class="h-10 w-10 bg-cyber/10 text-cyber rounded-lg flex items-center justify-center">
                            <i class="fas fa-download"></i>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-gray-900" id="total-resources">0</div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">Toplam İndirme</h3>
                        <div class="h-10 w-10 bg-primary/10 text-primary rounded-lg flex items-center justify-center">
                            <i class="fas fa-download"></i>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-gray-900" id="total-downloads">0</div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">PDF Kaynaklar</h3>
                        <div class="h-10 w-10 bg-accent/10 text-accent rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-gray-900" id="pdf-resources">0</div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-600">Araçlar</h3>
                        <div class="h-10 w-10 bg-secondary/10 text-secondary rounded-lg flex items-center justify-center">
                            <i class="fas fa-tools"></i>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-gray-900" id="tool-resources">0</div>
                </div>
            </div>

            <!-- Add Resource Form -->
            <div id="add-resource-form" class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-plus text-cyber mr-2"></i>
                    Yeni Kaynak Ekle
                </h2>
                
                <form id="resourceForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="resourceTitle" class="block text-sm font-medium text-gray-700 mb-2">Başlık *</label>
                            <input type="text" id="resourceTitle" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="resourceCategory" class="block text-sm font-medium text-gray-700 mb-2">Kategori *</label>
                            <select id="resourceCategory" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                                <option value="">Kategori Seçin</option>
                                <option value="pdf">PDF & Doküman</option>
                                <option value="code">Kod & Script</option>
                                <option value="tool">Araç & Yazılım</option>
                                <option value="template">Şablon</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="resourceDescription" class="block text-sm font-medium text-gray-700 mb-2">Açıklama *</label>
                        <textarea id="resourceDescription" rows="3" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="resourceFile" class="block text-sm font-medium text-gray-700 mb-2">Dosya Seçin</label>
                            <input type="file" id="resourceFile" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar,.txt,.py,.js,.html,.css,.java,.cpp,.c,.h,.sql,.xml,.json"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-cyber file:text-white hover:file:bg-cyber/90"
                                   onchange="updateFileInfo()">
                            <p class="text-xs text-gray-500 mt-1">Desteklenen formatlar: PDF, DOC, PPT, XLS, ZIP, Kod dosyaları</p>
                        </div>
                        
                        <div>
                            <label for="resourceUrl" class="block text-sm font-medium text-gray-700 mb-2">Alternatif URL</label>
                            <input type="url" id="resourceUrl" placeholder="https://example.com/resource"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Dosya yükleyemiyorsanız alternatif URL kullanın</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="resourceSize" class="block text-sm font-medium text-gray-700 mb-2">Dosya Boyutu</label>
                            <input type="text" id="resourceSize" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        
                        <div>
                            <label for="resourceLevel" class="block text-sm font-medium text-gray-700 mb-2">Zorluk Seviyesi *</label>
                            <select id="resourceLevel" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                                <option value="">Seviye Seçin</option>
                                <option value="Başlangıç">Başlangıç</option>
                                <option value="Orta">Orta</option>
                                <option value="İleri">İleri</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideResourceForm()" 
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                            İptal
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-cyber text-white rounded-lg hover:bg-cyber/90">
                            <i class="fas fa-save mr-2"></i>Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-8">
                <div class="flex flex-wrap gap-4">
                    <div>
                        <label for="filterCategory" class="block text-sm font-medium text-gray-700 mb-2">Kategori Filtresi</label>
                        <select id="filterCategory" onchange="filterResources()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                            <option value="">Tüm Kategoriler</option>
                            <option value="pdf">PDF & Doküman</option>
                            <option value="code">Kod & Script</option>
                            <option value="tool">Araç & Yazılım</option>
                            <option value="template">Şablon</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="filterLevel" class="block text-sm font-medium text-gray-700 mb-2">Seviye Filtresi</label>
                        <select id="filterLevel" onchange="filterResources()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyber focus:border-transparent">
                            <option value="">Tüm Seviyeler</option>
                            <option value="Başlangıç">Başlangıç</option>
                            <option value="Orta">Orta</option>
                            <option value="İleri">İleri</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Resources List -->
            <div id="resources-container" class="space-y-4">
                <!-- Resources will be loaded here -->
            </div>
        </div>
    </main>

    <script src="js/firebase-production.js"></script>
    <script src="js/user-utils.js"></script>
    <script>
        let editingResourceId = null;
        let currentResources = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadInstructorInfo();
            loadResources();
            setupEventListeners();
            ensureSidebarVisibility();
            
            // Start continuous sidebar visibility check
            startSidebarVisibilityCheck();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Add resource button
            document.getElementById('add-resource-btn').addEventListener('click', showResourceForm);
            
            // Form submission
            document.getElementById('resourceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (editingResourceId) {
                    editResource(editingResourceId);
                } else {
                    addResource();
                }
            });
        }

        // Load instructor info
        function loadInstructorInfo() {
            const instructorName = document.getElementById('instructor-name');
            const instructorEmail = document.getElementById('instructor-email');
            
            if (instructorName) {
                instructorName.textContent = 'Koordinatör';
            }
            if (instructorEmail) {
                instructorEmail.textContent = 'admin@kriptarium.com';
            }
        }

        // Load resources
        async function loadResources() {
            try {
                const result = await window.DB.load('downloads');
                if (result && result.success) {
                    currentResources = result.data || [];
                    displayResources(currentResources);
                    updateStats(currentResources);
                } else {
                    console.log('📚 Kaynak bulunamadı, boş liste gösteriliyor');
                    currentResources = [];
                    displayResources([]);
                    updateStats([]);
                }
            } catch (error) {
                console.error('❌ Kaynak yükleme hatası:', error);
                currentResources = [];
                displayResources([]);
                updateStats([]);
            }
        }

        // Display resources
        function displayResources(resources) {
            const container = document.getElementById('resources-container');
            if (!container) return;

            if (resources.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-download text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-medium text-gray-500 mb-2">Henüz kaynak bulunmuyor</h3>
                        <p class="text-gray-400">İlk kaynağı eklemek için "Yeni Kaynak Ekle" butonuna tıklayın</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = resources.map(resource => `
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-cyber/10 text-cyber rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas ${getResourceIcon(resource.category)}"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${resource.title}</h3>
                                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                                        <span class="flex items-center">
                                            <i class="fas fa-tag mr-1"></i>
                                            ${getCategoryName(resource.category)}
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-signal mr-1"></i>
                                            ${resource.level}
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-download mr-1"></i>
                                            ${resource.downloadCount || 0}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-gray-600 mb-3">${resource.description}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span>Boyut: ${resource.fileSize || 'N/A'}</span>
                                <span>Eklenme: ${new Date(resource.createdAt).toLocaleDateString('tr-TR')}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editResource('${resource.id}')" 
                                    class="px-3 py-1 bg-primary text-white rounded-lg text-sm hover:bg-primary/90">
                                <i class="fas fa-edit mr-1"></i>Düzenle
                            </button>
                            <button onclick="deleteResource('${resource.id}')" 
                                    class="px-3 py-1 bg-secondary text-white rounded-lg text-sm hover:bg-secondary/90">
                                <i class="fas fa-trash mr-1"></i>Sil
                            </button>
                            <button onclick="downloadResource('${resource.id}', '${resource.downloadUrl}', '${resource.fileName || resource.title}')" 
                                    class="px-3 py-1 bg-cyber text-white rounded-lg text-sm hover:bg-cyber/90">
                                <i class="fas fa-download mr-1"></i>İndir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStats(resources) {
            const totalResources = resources.length;
            const totalDownloads = resources.reduce((sum, r) => sum + (r.downloadCount || 0), 0);
            const pdfResources = resources.filter(r => r.category === 'pdf').length;
            const toolResources = resources.filter(r => r.category === 'tool').length;

            document.getElementById('total-resources').textContent = totalResources;
            document.getElementById('total-downloads').textContent = totalDownloads;
            document.getElementById('pdf-resources').textContent = pdfResources;
            document.getElementById('tool-resources').textContent = toolResources;
        }

        // Get resource icon
        function getResourceIcon(category) {
            const icons = {
                'pdf': 'fa-file-pdf',
                'code': 'fa-code',
                'tool': 'fa-tools',
                'template': 'fa-file-alt'
            };
            return icons[category] || 'fa-file';
        }

        // Get category name
        function getCategoryName(category) {
            const names = {
                'pdf': 'PDF & Doküman',
                'code': 'Kod & Script',
                'tool': 'Araç & Yazılım',
                'template': 'Şablon'
            };
            return names[category] || category;
        }

        // Show resource form
        function showResourceForm() {
            document.getElementById('add-resource-form').style.display = 'block';
            document.getElementById('add-resource-btn').style.display = 'none';
            
            // Show file size warning
            const warningDiv = document.createElement('div');
            warningDiv.className = 'bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg mb-4';
            warningDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <div>
                        <p class="font-medium">Dosya Boyutu Sınırı</p>
                        <p class="text-sm">Firebase ücretsiz planında maksimum dosya boyutu 1MB'dır. Daha büyük dosyalar için alternatif URL kullanın.</p>
                    </div>
                </div>
            `;
            
            const form = document.getElementById('resourceForm');
            form.insertBefore(warningDiv, form.firstChild);
        }

        // Hide resource form
        function hideResourceForm() {
            document.getElementById('add-resource-form').style.display = 'none';
            document.getElementById('add-resource-btn').style.display = 'block';
            document.getElementById('resourceForm').reset();
            document.getElementById('resourceFile').value = '';
            
            // Remove warning message if exists
            const warningDiv = document.querySelector('.bg-yellow-50');
            if (warningDiv) {
                warningDiv.remove();
            }
            
            editingResourceId = null;
            
            // Reset form button
            const submitButton = document.querySelector('#resourceForm button[type="submit"]');
            if (submitButton) {
                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Kaydet';
            }
        }

        // Update file info when file is selected
        function updateFileInfo() {
            const fileInput = document.getElementById('resourceFile');
            const sizeInput = document.getElementById('resourceSize');
            const categoryInput = document.getElementById('resourceCategory');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                
                // Check file size limit
                const maxSizeMB = 1;
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                
                if (parseFloat(sizeInMB) > maxSizeMB) {
                    alert(`⚠️ Uyarı: Dosya boyutu ${maxSizeMB}MB limitini aşıyor!\nSeçilen dosya: ${sizeInMB}MB\n\nFirebase ücretsiz planında büyük dosyalar yüklenemeyebilir.`);
                }
                
                // Update file size
                sizeInput.value = sizeInMB + ' MB';
                
                // Auto-detect category based on file extension
                const extension = file.name.split('.').pop().toLowerCase();
                if (['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(extension)) {
                    categoryInput.value = 'pdf';
                } else if (['py', 'js', 'html', 'css', 'java', 'cpp', 'c', 'h', 'sql', 'xml', 'json'].includes(extension)) {
                    categoryInput.value = 'code';
                } else if (['zip', 'rar', '7z'].includes(extension)) {
                    categoryInput.value = 'tool';
                } else {
                    categoryInput.value = 'template';
                }
                
                console.log('📁 Dosya seçildi:', file.name, 'Boyut:', sizeInMB + ' MB', 'Kategori:', categoryInput.value);
            }
        }

        // Add resource
        async function addResource() {
            try {
                const title = document.getElementById('resourceTitle').value;
                const category = document.getElementById('resourceCategory').value;
                const description = document.getElementById('resourceDescription').value;
                const fileInput = document.getElementById('resourceFile');
                const url = document.getElementById('resourceUrl').value;
                let size = document.getElementById('resourceSize').value;
                const level = document.getElementById('resourceLevel').value;

                if (!title || !category || !description || !level) {
                    alert('❌ Gerekli alanları doldurun!');
                    return;
                }

                if (!fileInput.files.length && !url) {
                    alert('❌ Lütfen bir dosya seçin veya alternatif URL girin!');
                    return;
                }

                let downloadUrl = url;
                let fileSize = size;
                let fileName = '';

                // If file is selected, process it
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    fileName = file.name;
                    
                    // Check file size (Firebase free plan limit: 1MB)
                    const maxSizeMB = 1;
                    const fileSizeMB = file.size / (1024 * 1024);
                    
                    if (fileSizeMB > maxSizeMB) {
                        alert(`❌ Dosya boyutu çok büyük! Maksimum ${maxSizeMB}MB olmalıdır. Seçilen dosya: ${fileSizeMB.toFixed(2)}MB`);
                        return;
                    }
                    
                    // Store file info instead of base64 (Firebase free plan friendly)
                    const resourceData = {
                        title: title,
                        category: category,
                        description: description,
                        downloadUrl: `file://${fileName}`, // File reference
                        fileName: fileName,
                        fileSize: fileSize,
                        fileType: file.type,
                        level: level,
                        downloadCount: 0,
                        rating: 4.5,
                        createdAt: new Date().toISOString(),
                        // Store file metadata for download simulation
                        fileMetadata: {
                            name: fileName,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified
                        }
                    };
                    
                    try {
                        const success = await window.DB.save('downloads', resourceData);
                        if (success && success.success) {
                            console.log('✅ Kaynak eklendi:', success.id);
                            alert('✅ Kaynak başarıyla eklendi! Dosya bilgileri kaydedildi.');
                            hideResourceForm();
                            await loadResources();
                        } else {
                            throw new Error('Kaynak ekleme başarısız');
                        }
                    } catch (error) {
                        console.error('❌ Kaynak ekleme hatası:', error);
                        alert('❌ Kaynak eklenirken hata oluştu: ' + error.message);
                    }
                    
                    return; // Exit early
                }

                // If no file is selected but URL is provided
                const resourceData = {
                    title: title,
                    category: category,
                    description: description,
                    downloadUrl: downloadUrl,
                    fileName: fileName, // Will be empty if no file
                    fileSize: fileSize,
                    level: level,
                    downloadCount: 0,
                    rating: 4.5,
                    createdAt: new Date().toISOString()
                };
                
                console.log('📥 Kaynak ekleniyor:', resourceData);

                const success = await window.DB.save('downloads', resourceData);
                if (success && success.success) {
                    console.log('✅ Kaynak eklendi:', success.id);
                    alert('✅ Kaynak başarıyla eklendi!');
                    hideResourceForm();
                    await loadResources();
                } else {
                    throw new Error('Kaynak ekleme başarısız');
                }
                
            } catch (error) {
                console.error('❌ Kaynak ekleme hatası:', error);
                alert('❌ Kaynak eklenirken hata oluştu: ' + error.message);
            }
        }

        // Edit resource
        async function editResource(resourceId) {
            try {
                const resourcesResult = await window.DB.load('downloads');
                const resources = (resourcesResult && resourcesResult.success) ? resourcesResult.data : [];
                const resource = resources.find(r => r.id === resourceId);
                
                if (!resource) {
                    alert('Kaynak bulunamadı!');
                    return;
                }
                
                // Fill form with existing data
                document.getElementById('resourceTitle').value = resource.title;
                document.getElementById('resourceCategory').value = resource.category;
                document.getElementById('resourceDescription').value = resource.description;
                document.getElementById('resourceUrl').value = resource.downloadUrl;
                document.getElementById('resourceSize').value = resource.fileSize;
                document.getElementById('resourceLevel').value = resource.level;
                
                // Clear file input for editing
                document.getElementById('resourceFile').value = '';
                
                // Set editing mode
                editingResourceId = resourceId;
                
                // Update form button
                const submitButton = document.querySelector('#resourceForm button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Değişiklikleri Kaydet';
                }
                
                // Show form
                showResourceForm();
                
                console.log('✏️ Düzenleme modu:', resourceId);
                
            } catch (error) {
                console.error('❌ Kaynak düzenleme hatası:', error);
                alert('❌ Kaynak düzenlenirken hata oluştu: ' + error.message);
            }
        }

        // Delete resource
        async function deleteResource(resourceId) {
            if (!confirm('Bu kaynağı silmek istediğinizden emin misiniz?')) {
                return;
            }
            
            try {
                const success = await window.DB.delete('downloads', resourceId);
                if (success && success.success) {
                    console.log('✅ Kaynak silindi:', resourceId);
                    alert('✅ Kaynak başarıyla silindi!');
                    await loadResources();
                } else {
                    throw new Error('Kaynak silme başarısız');
                }
            } catch (error) {
                console.error('❌ Kaynak silme hatası:', error);
                alert('❌ Kaynak silinirken hata oluştu: ' + error.message);
            }
        }

        // Filter resources
        function filterResources() {
            const categoryFilter = document.getElementById('filterCategory').value;
            const levelFilter = document.getElementById('filterLevel').value;
            
            // Reload resources and apply filters
            loadResources().then(() => {
                // Apply filters to displayed resources
                const resources = document.querySelectorAll('#resources-container > div');
                resources.forEach(resource => {
                    let show = true;
                    
                    if (categoryFilter && !resource.textContent.includes(getCategoryName(categoryFilter))) {
                        show = false;
                    }
                    
                    if (levelFilter && !resource.textContent.includes(levelFilter)) {
                        show = false;
                    }
                    
                    resource.style.display = show ? 'block' : 'none';
                });
            });
        }

        // Download resource function
        function downloadResource(resourceId, downloadUrl, fileName) {
            try {
                if (downloadUrl.startsWith('data:')) {
                    // Handle base64 data URLs (legacy)
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = fileName || 'resource';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else if (downloadUrl.startsWith('file://')) {
                    // Handle file references (new system)
                    alert(`📁 Dosya: ${fileName}\n\nBu dosya koordinatör tarafından yüklenmiş bir referanstır.\nGerçek dosya indirme için koordinatör ile iletişime geçin.\n\nDosya bilgileri:\n- Ad: ${fileName}\n- Boyut: ${getFileSizeFromResource(resourceId)}\n- Tür: ${getFileTypeFromResource(resourceId)}`);
                } else {
                    // Handle regular URLs
                    window.open(downloadUrl, '_blank');
                }
                
                // Update download count
                updateDownloadCount(resourceId);
                
                console.log('📥 Kaynak indirildi:', fileName);
            } catch (error) {
                console.error('❌ İndirme hatası:', error);
                alert('❌ Dosya indirilirken hata oluştu: ' + error.message);
            }
        }
        
        // Get file size from resource
        function getFileSizeFromResource(resourceId) {
            // This would need to be implemented to get actual file size
            return 'Bilinmiyor';
        }
        
        // Get file type from resource
        function getFileTypeFromResource(resourceId) {
            // This would need to be implemented to get actual file type
            return 'Bilinmiyor';
        }
        
        // Update download count
        async function updateDownloadCount(resourceId) {
            try {
                const resourcesResult = await window.DB.load('downloads');
                const resources = (resourcesResult && resourcesResult.success) ? resourcesResult.data : [];
                const resource = resources.find(r => r.id === resourceId);
                
                if (resource) {
                    resource.downloadCount = (resource.downloadCount || 0) + 1;
                    await window.DB.save('downloads', resource, resourceId);
                    console.log('📊 İndirme sayısı güncellendi:', resource.downloadCount);
                }
            } catch (error) {
                console.error('❌ İndirme sayısı güncelleme hatası:', error);
            }
        }
        
        // Logout function
        function logout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('loginTime');
                localStorage.removeItem('userRole');
                
                console.log('🚪 Koordinatör çıkışı yapıldı');
                window.location.href = 'index.html';
            }
        }
        
        // ULTRA STRONG SIDEBAR VISIBILITY SYSTEM
        function ensureSidebarVisibility() {
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                // Force sidebar to stay visible with ULTRA STRONG rules
                sidebar.style.position = 'fixed';
                sidebar.style.zIndex = '999999';
                sidebar.style.left = '0';
                sidebar.style.top = '0';
                sidebar.style.height = '100vh';
                sidebar.style.overflowY = 'auto';
                sidebar.style.transform = 'none';
                sidebar.style.willChange = 'auto';
                sidebar.style.pointerEvents = 'auto';
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                
                // Add CSS class for additional safety
                sidebar.classList.add('sidebar-container');
                
                console.log('🔒 Sidebar görünürlüğü korunuyor - Z-Index:', sidebar.style.zIndex);
            }
        }
        
        // Start continuous sidebar visibility check
        function startSidebarVisibilityCheck() {
            // Check every 50ms (ultra frequent)
            setInterval(ensureSidebarVisibility, 50);
            
            // Check on all possible events
            const events = ['scroll', 'resize', 'load', 'visibilitychange', 'focus', 'blur', 'click', 'mousemove', 'keydown'];
            events.forEach(event => {
                window.addEventListener(event, ensureSidebarVisibility);
                document.addEventListener(event, ensureSidebarVisibility);
            });
            
            // Additional safety: check on DOM changes
            const observer = new MutationObserver(ensureSidebarVisibility);
            observer.observe(document.body, { 
                childList: true, 
                subtree: true, 
                attributes: true,
                attributeFilter: ['style', 'class']
            });
            
            console.log('🚀 Ultra güçlü sidebar görünürlük sistemi başlatıldı!');
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', ensureSidebarVisibility);
        window.addEventListener('load', ensureSidebarVisibility);
    </script>
</body>
</html>
