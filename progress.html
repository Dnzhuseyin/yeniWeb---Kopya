<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İlerlemem - Kriptarium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#dc2626',
                        accent: '#059669',
                        cyber: '#6366f1',
                        dark: '#0f172a'
                    }
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-production.js"></script>
    <script src="js/user-utils.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex">
    <!-- Sidebar -->
    <aside class="bg-dark text-white w-64 min-h-screen fixed left-0 top-0 z-20 hidden md:block">
        <div class="p-4">
            <a href="student-dashboard.html" class="font-bold text-xl text-cyber block mb-8 flex items-center">
                <i class="fas fa-key text-2xl mr-3"></i>
                Kriptarium
            </a>
            
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div>
                        <p class="font-medium" id="user-name"></p>
                        <p class="text-sm text-gray-400" id="user-email"></p>
                    </div>
                </div>
            </div>
            
            <nav class="space-y-1">
                <a href="student-dashboard.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>Genel Bakış</span>
                </a>
                <a href="courses.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-graduation-cap mr-3"></i>
                    <span>Eğitim Modülleri</span>
                </a>
                <a href="progress.html" class="flex items-center px-4 py-3 rounded-lg bg-slate-800">
                    <i class="fas fa-chart-line mr-3 text-cyber"></i>
                    <span>İlerlemem</span>
                </a>
                <a href="my-notes.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-sticky-note mr-3"></i>
                    <span>Notlarım</span>
                </a>
                <a href="downloads.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-download mr-3"></i>
                    <span>Kaynaklar</span>
                </a>
                <a href="account.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-user-cog mr-3"></i>
                    <span>Profil Ayarları</span>
                </a>
            </nav>

            <div class="absolute bottom-0 left-0 w-full p-4 border-t border-slate-800">
                <a href="index.html" class="flex items-center text-gray-400 hover:text-white">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span>Çıkış Yap</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- Mobile menu -->
    <div class="md:hidden fixed top-0 left-0 right-0 z-20 bg-slate-900 text-white p-4 flex justify-between items-center">
        <a href="student-dashboard.html" class="font-bold text-xl text-primary">Çevik Liderlik</a>
        <button class="text-white" id="mobile-menu-button">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>

    <!-- Main content -->
    <main class="md:ml-64 p-4 md:p-8 w-full min-h-screen">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
                            <i class="fas fa-chart-line text-cyber mr-3"></i>
                            İlerlemem
                        </h1>
                        <p class="text-gray-600">Siber güvenlik eğitimi ilerlemenizi takip edin</p>
                    </div>
                    <div class="bg-white rounded-lg px-4 py-2 shadow-sm border border-gray-100">
                        <span class="text-sm text-gray-600">Güvenlik Seviyesi:</span>
                        <span class="font-bold text-cyber ml-1" id="security-level">Başlangıç</span>
                    </div>
                </div>
            </header>
            
            <!-- Overall Progress -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-trophy text-cyber mr-2"></i>
                        Genel İlerleme
                    </h2>
                    <span class="text-lg font-bold text-cyber" id="overall-progress">25%</span>
                </div>
                
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div class="bg-gradient-to-r from-cyber to-primary h-4 rounded-full transition-all duration-500" style="width: 25%" id="progress-bar"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-accent" id="completed-modules">2</div>
                        <div class="text-sm text-gray-600">Tamamlanan</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyber" id="current-modules">1</div>
                        <div class="text-sm text-gray-600">Devam Eden</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-400" id="locked-modules">5</div>
                        <div class="text-sm text-gray-600">Kilitli</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-primary" id="avg-score">85</div>
                        <div class="text-sm text-gray-600">Ortalama Puan</div>
                    </div>
                        </div>
                    </div>
                    
            <!-- Module Progress -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-100">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fas fa-graduation-cap text-primary mr-2"></i>
                    Modül İlerlemesi
                </h2>
                
                <div class="space-y-6" id="module-progress-container">
                    <!-- Module progress items will be loaded here -->
                </div>
            </div>
            
            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Learning Stats -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-brain text-cyber mr-2"></i>
                        Öğrenme İstatistikleri
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">İzlenen Video</span>
                            <span class="font-semibold" id="watched-videos">12/24</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Çözülen Soru</span>
                            <span class="font-semibold" id="solved-questions">45/80</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Alınan Not</span>
                            <span class="font-semibold" id="total-notes">18</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Toplam Süre</span>
                            <span class="font-semibold" id="study-time">24 saat</span>
                    </div>
                </div>
            </div>
            
                <!-- Achievement -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-medal text-accent mr-2"></i>
                        Başarılar
                    </h3>
                    
                    <div class="space-y-3" id="achievements-container">
                        <!-- Achievements will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/main.js"></script>
    
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📊 İlerleme sayfası yükleniyor...');
            
            // Initialize user info using UserUtils
            const isLoggedIn = await UserUtils.initializeUserInfo();
            if (!isLoggedIn) return;
            
            // Wait for Firebase to be ready
            await new Promise(resolve => {
                const checkDB = () => {
                    if (window.DB) {
                        console.log('✅ Firebase Production DB hazır!');
                        resolve();
                    } else {
                        console.log('⏳ Firebase Production DB bekleniyor...');
                        setTimeout(checkDB, 200);
                    }
                };
                checkDB();
            });
            
            await loadProgressData();
            setupEventListeners();
            
            console.log('✅ İlerleme sayfası hazır!');
        });

        // Load real progress data from Firebase
        async function loadProgressData() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                if (!userEmail) {
                    console.warn('⚠️ Kullanıcı e-postası bulunamadı');
                    return;
                }
                
                console.log('📈 İlerleme verileri yükleniyor...');
                
                // Load user progress data
                const progressResult = await window.DB.load('userProgress');
                const progressData = (progressResult && progressResult.success) ? progressResult.data : [];
                const userProgressData = progressData.filter(p => p.userEmail === userEmail);
                
                // Load modules
                const modulesResult = await window.DB.loadModules();
                const modules = (modulesResult && modulesResult.success) ? modulesResult.data : [];
                
                // Load coordinator videos for total video count
                const videosResult = await window.DB.load('coordinatorVideos');
                const videos = (videosResult && videosResult.success) ? videosResult.data : [];
                
                // Load user profile for additional info
                const profileResult = await window.DB.load('userProfiles');
                const profiles = (profileResult && profileResult.success) ? profileResult.data : [];
                const userProfile = profiles.find(p => p.userEmail === userEmail);
                
                // Calculate statistics
                const totalModules = modules.length || 8;
                const completedModules = userProgressData.filter(p => p.completionRate >= 100).length;
                const totalVideos = videos.length;
                const watchedVideos = userProgressData.reduce((sum, p) => sum + (p.watchedVideos || 0), 0);
                const totalExamScore = userProgressData.reduce((sum, p) => sum + (p.examScore || 0), 0);
                const averageScore = userProgressData.length > 0 ? Math.round(totalExamScore / userProgressData.length) : 0;
                const overallProgress = Math.round((completedModules / totalModules) * 100);
                
                // Update UI with real data
                await updateProgressDisplay(userProgressData, modules, {
                    totalModules,
                    completedModules,
                    totalVideos,
                    watchedVideos,
                    averageScore,
                    overallProgress,
                    userProfile
                });
                
                console.log('✅ İlerleme verileri başarıyla yüklendi');
                
            } catch (error) {
                console.error('❌ İlerleme veri yükleme hatası:', error);
                showError('İlerleme verileriniz yüklenirken hata oluştu: ' + error.message);
            }
        }

        // Update progress display with real data
        async function updateProgressDisplay(userProgressData, modules, stats) {
            // Update header statistics
            updateHeaderStats(stats);
            
            // Update user info
            updateUserInfo(stats.userProfile);
            
            // Update module progress list
            updateModuleProgressList(userProgressData, modules);
            
            // Update achievement section
            updateAchievements(stats.completedModules, stats.averageScore);
            
            // Update progress chart/visualization
            updateProgressVisualization(userProgressData, modules);
        }

        // Update header statistics
        function updateHeaderStats(stats) {
            // Update progress cards
            const completedModulesEl = document.getElementById('completed-modules');
            const totalModulesEl = document.getElementById('total-modules');
            const watchedVideosEl = document.getElementById('watched-videos');
            const totalVideosEl = document.getElementById('total-videos');
            const avgScoreEl = document.getElementById('avg-score');
            const overallProgressEl = document.getElementById('overall-progress');
            const progressBarEl = document.getElementById('progress-bar');
            
            // Update main progress cards
            if (completedModulesEl) completedModulesEl.textContent = stats.completedModules;
            if (totalModulesEl) totalModulesEl.textContent = stats.totalModules;
            if (avgScoreEl) avgScoreEl.textContent = stats.averageScore;
            if (overallProgressEl) overallProgressEl.textContent = `${stats.overallProgress}%`;
            if (progressBarEl) progressBarEl.style.width = `${stats.overallProgress}%`;
            
            // Update learning statistics section
            if (watchedVideosEl) watchedVideosEl.textContent = `${stats.watchedVideos}/${stats.totalVideos}`;
            
            // Update other learning stats
            const solvedQuestionsEl = document.getElementById('solved-questions');
            const totalNotesEl = document.getElementById('total-notes');
            const studyTimeEl = document.getElementById('study-time');
            
            // Calculate solved questions based on completed modules and average score
            const estimatedQuestions = stats.completedModules * 10; // Assume 10 questions per module
            const totalPossibleQuestions = stats.totalModules * 10;
            if (solvedQuestionsEl) solvedQuestionsEl.textContent = `${estimatedQuestions}/${totalPossibleQuestions}`;
            
            // Estimate notes based on modules
            const estimatedNotes = stats.completedModules * 3; // Assume 3 notes per completed module
            if (totalNotesEl) totalNotesEl.textContent = estimatedNotes;
            
            // Calculate study time based on watched videos (assume 30 min per video)
            const estimatedHours = Math.round((stats.watchedVideos * 30) / 60);
            if (studyTimeEl) studyTimeEl.textContent = `${estimatedHours} saat`;
            
            // Update current and locked modules
            const currentModulesEl = document.getElementById('current-modules');
            const lockedModulesEl = document.getElementById('locked-modules');
            
            const currentModules = stats.totalModules - stats.completedModules;
            const lockedModules = Math.max(0, stats.totalModules - stats.completedModules - 1); // Assume next module is unlocked
            
            if (currentModulesEl) currentModulesEl.textContent = Math.max(1, currentModules);
            if (lockedModulesEl) lockedModulesEl.textContent = lockedModules;
        }

        // Update user info in sidebar
        function updateUserInfo(userProfile) {
            const userNameEl = document.getElementById('user-name');
            const userEmailEl = document.getElementById('user-email');
            
            if (userProfile) {
                const fullName = `${userProfile.firstName || ''} ${userProfile.lastName || ''}`.trim();
                if (userNameEl) userNameEl.textContent = fullName || 'Kullanıcı';
                if (userEmailEl) userEmailEl.textContent = userProfile.userEmail || '';
            } else {
                const userEmail = localStorage.getItem('userEmail');
                if (userEmail) {
                    const userName = extractNameFromEmail(userEmail);
                    if (userNameEl) userNameEl.textContent = userName;
                    if (userEmailEl) userEmailEl.textContent = userEmail;
                }
            }
        }

        // Update module progress list
        function updateModuleProgressList(userProgressData, modules) {
            const moduleProgressContainer = document.getElementById('module-progress-container');
            if (!moduleProgressContainer) return;
            
            // Use modules from database or create sample ones if none exist
            let cyberModules = modules;
            if (!cyberModules || cyberModules.length === 0) {
                console.log('⚠️ Hiç modül bulunamadı, örnek modüller oluşturuluyor...');
                await createSampleModules();
                const newModulesResult = await window.DB.loadModules();
                cyberModules = (newModulesResult && newModulesResult.success) ? newModulesResult.data : [];
            }
            
            moduleProgressContainer.innerHTML = '';
            
            cyberModules.forEach(module => {
                const userProgress = userProgressData.find(p => p.moduleId == module.id) || { completionRate: 0, examScore: 0 };
                const progressPercent = userProgress.completionRate || 0;
                const examScore = userProgress.examScore || 0;
                
                const moduleDiv = document.createElement('div');
                moduleDiv.className = 'bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow';
                moduleDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-cyber to-primary rounded-lg flex items-center justify-center">
                                <i class="fas ${getModuleIcon(module.id)} text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${module.title}</h3>
                                <p class="text-sm text-gray-600">${module.description}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-gray-900">${Math.round(progressPercent)}%</div>
                            <div class="text-sm text-gray-500">Tamamlandı</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">İlerleme</span>
                                <span class="text-cyber font-medium">${Math.round(progressPercent)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-cyber to-primary h-2 rounded-full transition-all duration-500" 
                                     style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-4">
                                <span class="text-gray-600">
                                    <i class="fas fa-trophy mr-1"></i>
                                    Sınav: ${examScore}/100
                                </span>
                                <span class="text-gray-600">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${getStatusText(progressPercent)}
                                </span>
                            </div>
                            <button onclick="goToModule('${module.id}')" 
                                    class="text-cyber hover:text-primary font-medium">
                                ${progressPercent === 100 ? 'Tekrar Et' : progressPercent > 0 ? 'Devam Et' : 'Başla'} →
                            </button>
                        </div>
                    </div>
                `;
                moduleProgressContainer.appendChild(moduleDiv);
            });
                }

        // Create sample modules if none exist
        async function createSampleModules() {
            try {
                console.log('🔧 Örnek modüller oluşturuluyor...');
                const sampleModules = [
                    {
                        title: 'Bilgi Güvenliği Temelleri',
                        description: 'Bilgi güvenliğinin temel prensipleri ve kavramları',
                        category: 'Temel',
                        difficulty: 'beginner',
                        order: 1
                    },
                    {
                        title: 'Kriptoloji ve Şifreleme',
                        description: 'Kriptografi, hash fonksiyonları ve dijital imzalar',
                        category: 'Güvenlik',
                        difficulty: 'intermediate',
                        order: 2
                    },
                    {
                        title: 'Ağ Güvenliği',
                        description: 'Ağ protokolleri, firewall ve VPN teknolojileri',
                        category: 'Ağ',
                        difficulty: 'intermediate',
                        order: 3
                    },
                    {
                        title: 'Web Güvenliği',
                        description: 'OWASP Top 10, XSS, SQL Injection ve güvenli kodlama',
                        category: 'Web',
                        difficulty: 'advanced',
                        order: 4
                    },
                    {
                        title: 'Malware Analizi',
                        description: 'Zararlı yazılım türleri, analiz teknikleri ve korunma',
                        category: 'Analiz',
                        difficulty: 'advanced',
                        order: 5
                    }
                ];

                for (const module of sampleModules) {
                    await window.DB.saveModule(module);
                }
                console.log('✅ Örnek modüller oluşturuldu');
            } catch (error) {
                console.error('❌ Örnek modül oluşturma hatası:', error);
            }
        }
        
        // Update achievements based on progress
        function updateAchievements(completedModules, averageScore) {
            const achievementsContainer = document.getElementById('achievements-container');
            if (!achievementsContainer) return;
            
            let achievements = [];
            
            if (completedModules >= 1) {
                achievements.push({
                    title: 'İlk Adım',
                    description: 'İlk modülünüzü tamamladınız',
                    icon: 'fa-star',
                    color: 'accent',
                    earned: true
                });
            }
            
            if (completedModules >= 3) {
                achievements.push({
                    title: 'Güvenlik Uzmanı',
                    description: 'Temel güvenlik modüllerini tamamladınız',
                    icon: 'fa-shield-alt',
                    color: 'primary',
                    earned: true
                });
            }
            
            if (completedModules >= 5) {
                achievements.push({
                    title: 'Kriptoloji Ustası',
                    description: 'Şifreleme konularında uzmanlaştınız',
                    icon: 'fa-key',
                    color: 'cyber',
                    earned: true
                });
            }
            
            if (averageScore >= 80) {
                achievements.push({
                    title: 'Yüksek Performans',
                    description: 'Sınavlarda 80+ ortalama aldınız',
                    icon: 'fa-trophy',
                    color: 'secondary',
                    earned: true
                });
            }
            
            // Add upcoming achievements
            if (completedModules < 8) {
                achievements.push({
                    title: 'Siber Güvenlik Uzmanı',
                    description: 'Tüm modülleri tamamlayın',
                    icon: 'fa-graduation-cap',
                    color: 'gray',
                    earned: false
                });
            }
            
            achievementsContainer.innerHTML = achievements.map(achievement => `
                <div class="flex items-center space-x-4 p-4 rounded-lg ${achievement.earned ? `bg-${achievement.color}/5 border border-${achievement.color}/20` : 'bg-gray-50 border border-gray-200'}">
                    <div class="w-12 h-12 ${achievement.earned ? `bg-${achievement.color}/10 text-${achievement.color}` : 'bg-gray-200 text-gray-400'} rounded-lg flex items-center justify-center">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium ${achievement.earned ? 'text-gray-900' : 'text-gray-500'}">${achievement.title}</h4>
                        <p class="text-sm ${achievement.earned ? 'text-gray-600' : 'text-gray-400'}">${achievement.description}</p>
                    </div>
                    ${achievement.earned ? '<i class="fas fa-check-circle text-accent"></i>' : '<i class="fas fa-lock text-gray-400"></i>'}
                </div>
            `).join('');
        }

        // Update progress visualization
        function updateProgressVisualization(userProgressData, modules) {
            // This could include charts, graphs, or other visual representations
            // For now, we'll update the overall progress indicator
            const overallProgress = userProgressData.length > 0 ? 
                Math.round(userProgressData.reduce((sum, p) => sum + (p.completionRate || 0), 0) / userProgressData.length) : 0;
            
            const progressElements = document.querySelectorAll('.progress-indicator');
            progressElements.forEach(el => {
                el.style.width = `${overallProgress}%`;
            });
        }

        // Helper functions
        function getModuleIcon(moduleId) {
            const icons = {
                '1': 'fa-shield-alt',
                '2': 'fa-key',
                '3': 'fa-network-wired',
                '4': 'fa-globe',
                '5': 'fa-bug',
                '6': 'fa-search',
                '7': 'fa-exclamation-triangle',
                '8': 'fa-certificate'
            };
            return icons[moduleId] || 'fa-book';
        }

        function getStatusText(progressPercent) {
            if (progressPercent === 100) return 'Tamamlandı';
            if (progressPercent > 50) return 'Devam Ediyor';
            if (progressPercent > 0) return 'Başladı';
            return 'Başlamadı';
        }

        function extractNameFromEmail(email) {
            const name = email.split('@')[0];
            return name.split('.').map(part => 
                part.charAt(0).toUpperCase() + part.slice(1)
            ).join(' ');
        }

        function goToModule(moduleId) {
            window.location.href = `module-detail.html?module=${moduleId}`;
        }

        function showError(message) {
            console.error('❌ Hata:', message);
            alert('❌ ' + message);
        }

        function showSuccess(message) {
            console.log('✅ Başarılı:', message);
            alert('✅ ' + message);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout functionality
            document.querySelectorAll('a[href="index.html"]').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('loginTime');
                    
                    window.location.href = 'index.html';
                });
            });
        }
    </script>
</body>
</html> 