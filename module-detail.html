<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mod√ºl Detayƒ± - EduPlatform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#dc2626',
                        accent: '#059669',
                        cyber: '#6366f1',
                        dark: '#0f172a'
                    }
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen flex">
    <!-- Sidebar -->
    <aside class="bg-dark text-white w-64 min-h-screen fixed left-0 top-0 z-20 hidden md:block">
        <div class="p-4">
            <a href="student-dashboard.html" class="font-bold text-xl text-cyber block mb-8 flex items-center">
                <i class="fas fa-graduation-cap text-2xl mr-3"></i>
                EduPlatform
            </a>
            
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div>
                        <p class="font-medium" id="user-name"></p>
                        <p class="text-sm text-gray-400" id="user-email"></p>
                    </div>
                </div>
            </div>
            
            <nav class="space-y-1">
                <a href="student-dashboard.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>Genel Bakƒ±≈ü</span>
                </a>
                <a href="courses.html" class="flex items-center px-4 py-3 rounded-lg bg-slate-800">
                    <i class="fas fa-graduation-cap mr-3 text-cyber"></i>
                    <span>Eƒüitim Mod√ºlleri</span>
                </a>
                <a href="progress.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-chart-line mr-3"></i>
                    <span>ƒ∞lerlemem</span>
                </a>
                <a href="my-notes.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-sticky-note mr-3"></i>
                    <span>Notlarƒ±m</span>
                </a>
                <a href="account.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-800">
                    <i class="fas fa-user-cog mr-3"></i>
                    <span>Profil Ayarlarƒ±</span>
                </a>
            </nav>

            <div class="absolute bottom-0 left-0 w-full p-4 border-t border-slate-800">
                <a href="#" onclick="logout()" class="flex items-center text-gray-400 hover:text-white">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span>√áƒ±kƒ±≈ü Yap</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <main class="md:ml-64 p-4 md:p-8 w-full min-h-screen">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex items-center mb-4">
                    <a href="courses.html" class="text-cyber hover:text-primary mr-4">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div>
                        <h1 class="text-3xl font-bold flex items-center" id="module-title">
                            <i class="fas fa-shield-alt text-cyber mr-3"></i>
                            Mod√ºl Y√ºkleniyor...
                        </h1>
                        <p class="text-gray-600 mt-2" id="module-description">ƒ∞√ßerik y√ºkleniyor...</p>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="bg-white p-4 rounded-lg shadow-md border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">Mod√ºl ƒ∞lerlemesi</span>
                        <span class="text-sm font-bold text-cyber" id="module-progress">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-cyber to-primary h-2 rounded-full" style="width: 0%" id="progress-bar"></div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Video Content -->
                <div class="lg:col-span-2">
                    <!-- Video Player -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6 border border-gray-100">
                        <div class="aspect-video bg-black relative" id="video-container">
                            <video class="w-full h-full" controls id="main-video">
                                <source src="#" type="video/mp4" id="video-source">
                                Video y√ºklenemedi.
                            </video>
                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white" id="video-placeholder">
                                <div class="text-center">
                                    <i class="fas fa-play-circle text-6xl mb-4 opacity-75"></i>
                                    <p class="text-lg">Video Y√ºkleniyor...</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <h2 class="text-xl font-semibold mb-2" id="video-title">Video Y√ºkleniyor...</h2>
                            <p class="text-gray-600 mb-4" id="video-description">A√ßƒ±klama y√ºkleniyor...</p>
                            
                            <!-- Video Controls -->
                            <div class="flex items-center justify-between border-t pt-4">
                                <div class="flex items-center space-x-4">
                                    <button class="text-gray-600 hover:text-cyber" id="prev-video">
                                        <i class="fas fa-step-backward"></i> √ñnceki
                                    </button>
                                    <button class="text-gray-600 hover:text-cyber" id="next-video">
                                        Sonraki <i class="fas fa-step-forward"></i>
                                    </button>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-600 hover:text-cyber" id="add-note">
                                        <i class="far fa-sticky-note mr-1"></i> Not Ekle
                                    </button>
                                    <button class="text-gray-600 hover:text-cyber" id="bookmark-video">
                                        <i class="far fa-bookmark mr-1"></i> ƒ∞≈üaretle
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Section - Videonun Altƒ±nda -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-6 flex items-center">
                            <i class="fas fa-question-circle mr-2 text-primary"></i>
                            Video Test Sorularƒ±
                        </h3>
                        <div id="questions-container">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                                <p class="text-sm">Sorular y√ºkleniyor...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Module Contents -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-list mr-2 text-cyber"></i>
                            Mod√ºl ƒ∞√ßeriƒüi
                        </h3>
                        
                        <div class="space-y-3" id="video-list">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                                <p class="text-sm">Videolar y√ºkleniyor...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="far fa-sticky-note mr-2 text-accent"></i>
                            Hƒ±zlƒ± Notlar
                        </h3>
                        
                        <textarea 
                            class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-cyber focus:border-transparent" 
                            rows="4" 
                            placeholder="Notlarƒ±nƒ±zƒ± buraya yazƒ±n..."
                            id="quick-notes"></textarea>
                        
                        <button class="w-full mt-3 bg-accent text-white py-2 rounded-lg hover:bg-green-600" id="save-note">
                            <i class="fas fa-save mr-2"></i>Notu Kaydet
                        </button>
                        
                        <div class="mt-4 space-y-2" id="saved-notes">
                            <p class="text-gray-500 text-sm">Hen√ºz not yok</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Note Modal -->
    <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold mb-4">Video Notu Ekle</h3>
                <textarea 
                    class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-cyber" 
                    rows="4" 
                    placeholder="Notunuzu yazƒ±n..."
                    id="video-note-text"></textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button class="px-4 py-2 text-gray-600 hover:text-gray-800" id="cancel-note">ƒ∞ptal</button>
                    <button class="bg-cyber text-white px-4 py-2 rounded-lg" id="save-video-note">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-production.js"></script>
    <script src="js/user-utils.js"></script>
    <script src="js/groq-api.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // Module data - Empty initially, will be populated by coordinator videos
        // Module data will be loaded dynamically from Firebase
        const moduleData = {};

        let currentModule = 2;
        let currentVideoId = 1;
        let currentVideo = null; // Current video object
        let userAnswers = {};
        let wrongAnswers = [];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await UserUtils.initializeUserInfo();
            loadModuleContent();
        });
        
        async function loadModuleContent() {
            // Wait for Firebase to be ready
            await new Promise(resolve => {
                const checkDB = () => {
                    if (window.DB) {
                        console.log('‚úÖ Firebase Production DB hazƒ±r!');
                        resolve();
                    } else {
                        console.log('‚ö†Ô∏è DB hen√ºz hazƒ±r deƒüil, bekleniyor...');
                        setTimeout(checkDB, 100);
                    }
                };
                checkDB();
            });
            
            // Get module from URL - keep as string to match Firebase IDs
            const urlParams = new URLSearchParams(window.location.search);
            const moduleParam = urlParams.get('module');
            if (moduleParam) {
                currentModule = moduleParam; // Keep as string, don't convert to number
                console.log('üìç URL\'den alƒ±nan mod√ºl ID:', currentModule, 'Tip:', typeof currentModule);
            }
            
            // Always start from first video
                currentVideoId = 1;

            // Load coordinator videos
            await loadCoordinatorVideos();
            
            // Load module content
            loadModule();
            setupEventListeners();
            loadSavedNotes();
        }
        
        async function loadCoordinatorVideos() {
            console.log('üî• Loading coordinator videos for module:', currentModule);
            
            try {
                // Wait for Firebase to be ready
                if (!window.DB || !window.DB.isFirebaseReady) {
                    console.log('‚è≥ Firebase hazƒ±r deƒüil, bekleniyor...');
                    let waitAttempts = 0;
                    while ((!window.DB || !window.DB.isFirebaseReady) && waitAttempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        waitAttempts++;
                        console.log(`‚è≥ Firebase bekleme denemesi: ${waitAttempts}/10`);
                    }
                }

                if (!window.DB || !window.DB.isFirebaseReady) {
                    console.error('‚ùå Firebase y√ºklenemedi');
                    return;
                }

                // Load videos
                const coordinatorVideos = await window.DB.getCoordinatorVideos();
                const studentVideos = await window.DB.getStudentVideos();

                console.log('üîç T√ºm koordinat√∂r videolarƒ±:', coordinatorVideos);
                console.log('üîç Aranan mod√ºl ID:', currentModule, 'Tip:', typeof currentModule);
                
                // Debug: Her videonun moduleId'sini kontrol et
                coordinatorVideos.forEach((video, index) => {
                    console.log(`Video ${index + 1}: moduleId = "${video.moduleId}" (tip: ${typeof video.moduleId}), title = "${video.title}"`);
                });

                // Filter by current module - t√ºm olasƒ± tipleri kontrol et
                const moduleCoordinatorVideos = coordinatorVideos.filter(video => {
                    const videoModuleId = String(video.moduleId).trim();
                    const currentModuleStr = String(currentModule).trim();
                    const match = videoModuleId === currentModuleStr || 
                                  video.moduleId == currentModule ||
                                  parseInt(videoModuleId) === parseInt(currentModuleStr);
                    
                    if (match) {
                        console.log(`‚úÖ Video e≈üle≈üti: "${video.title}" (moduleId: ${video.moduleId})`);
                    }
                    
                    return match;
                });
                
                const moduleStudentVideos = studentVideos.filter(video => {
                    const videoModuleId = String(video.moduleId).trim();
                    const currentModuleStr = String(currentModule).trim();
                    return videoModuleId === currentModuleStr || 
                           video.moduleId == currentModule ||
                           parseInt(videoModuleId) === parseInt(currentModuleStr);
                });

                // Combine all videos
                const allVideos = [...moduleCoordinatorVideos, ...moduleStudentVideos];

                console.log(`üìä Mod√ºl ${currentModule} i√ßin ${allVideos.length} video bulundu`);
                console.log('Coordinator videos:', moduleCoordinatorVideos.length);
                console.log('Student videos:', moduleStudentVideos.length);
                
                if (allVideos.length > 0) {
                    // Map to our format
                    const videoObjects = allVideos.map((video, index) => ({
                        id: index + 1,
                        title: video.title || `Video ${index + 1}`,
                        description: video.description || 'A√ßƒ±klama yok',
                        duration: video.duration || '0:00',
                        videoUrl: video.youtubeUrl || video.videoUrl || '#',  // Try both fields
                        youtubeVideoId: video.youtubeVideoId || '',
                        completed: false,
                        questions: video.questions || []
                    }));

                    // Update module data
                    if (!moduleData[currentModule]) {
                        moduleData[currentModule] = {
                            title: `Mod√ºl ${currentModule}`,
                            description: `Mod√ºl ${currentModule} i√ßeriƒüi`,
                            videos: videoObjects
                        };
                    } else {
                        moduleData[currentModule].videos = videoObjects;
                    }

                    console.log(`‚úÖ ${videoObjects.length} video y√ºklendi`);
                } else {
                    console.log('‚ö†Ô∏è No videos found for module', currentModule);
                    if (!moduleData[currentModule]) {
                        moduleData[currentModule] = {
                            title: `Mod√ºl ${currentModule}`,
                            description: `Bu mod√ºl i√ßin hen√ºz video eklenmemi≈ü`,
                            videos: []
                        };
                    } else {
                        moduleData[currentModule].videos = [];
                        moduleData[currentModule].description = `Bu mod√ºl i√ßin hen√ºz video eklenmemi≈ü`;
                    }
                }

            } catch (error) {
                console.error('‚ùå Error loading videos:', error);
                if (!moduleData[currentModule]) {
                    moduleData[currentModule] = {
                        title: `Mod√ºl ${currentModule}`,
                        description: `Video y√ºkleme hatasƒ±`,
                        videos: []
                    };
                } else {
                    moduleData[currentModule].videos = [];
                    moduleData[currentModule].description = `Video y√ºkleme hatasƒ±`;
                }
            }
        }

        async function loadModule() {
            // Load module info from Firebase
            const moduleResult = await window.DB.load('modules', currentModule);
            const module = (moduleResult && moduleResult.success) ? moduleResult.data : null;
            
            console.log('üìö Mod√ºl bilgisi y√ºklendi:', module);
            
            if (!module) {
                console.warn('‚ö†Ô∏è Mod√ºl bulunamadƒ±, moduleData kontrol ediliyor...');
                // Fallback to moduleData
                const moduleFromData = moduleData[currentModule];
                if (!moduleFromData) {
                    document.getElementById('module-title').innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>Mod√ºl Bulunamadƒ±';
                    document.getElementById('module-description').textContent = 'Bu mod√ºl mevcut deƒüil.';
                    return;
                }
                
                // Use moduleData
                document.getElementById('module-title').innerHTML = `<i class="fas fa-graduation-cap text-cyber mr-3"></i>${moduleFromData.title}`;
                document.getElementById('module-description').textContent = moduleFromData.description;
            } else {
                // Use Firebase module
                document.getElementById('module-title').innerHTML = `<i class="fas fa-graduation-cap text-cyber mr-3"></i>${module.title}`;
            document.getElementById('module-description').textContent = module.description;
            }

            // Load video list
            loadVideoList();
            
            // Load first video or current video
            const moduleVideos = moduleData[currentModule]?.videos || [];
            if (moduleVideos.length > 0) {
                let videoToLoad = moduleVideos.find(v => v.id === currentVideoId);
                if (!videoToLoad) {
                    videoToLoad = moduleVideos[0];
                    currentVideoId = videoToLoad.id;
                }
                loadVideo(videoToLoad);
            } else {
                showNoVideosMessage();
            }
        }

        function showNoVideosMessage() {
            document.getElementById('video-title').textContent = 'Video Mevcut Deƒüil';
            document.getElementById('video-description').textContent = 'Bu mod√ºl i√ßin hen√ºz video eklenmemi≈ütir.';
            document.getElementById('video-placeholder').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-video-slash text-6xl mb-4 opacity-75"></i>
                    <p class="text-lg">Video Mevcut Deƒüil</p>
                    <p class="text-sm opacity-75 mt-2">Koordinat√∂r tarafƒ±ndan video eklendiƒüinde burada g√∂r√ºnecektir.</p>
                    </div>
                `;
                
            document.getElementById('main-video').style.display = 'none';
            document.getElementById('video-placeholder').style.display = 'flex';
        }

        async function loadVideoList() {
            const module = moduleData[currentModule];
            const videoList = document.getElementById('video-list');
            
            if (!module || !module.videos || module.videos.length === 0) {
                videoList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-video-slash text-3xl mb-3"></i>
                        <p class="text-sm">Bu mod√ºl i√ßin hen√ºz video eklenmemi≈ütir.</p>
                    </div>
                `;
                return;
            }
            
            // Get user progress from Firebase
            const userEmail = localStorage.getItem('userEmail');
            let userProgress = {};
            
            if (userEmail && window.DB) {
                try {
                    const progressResult = await window.DB.load('userProgress');
                    if (progressResult && progressResult.success) {
                        const allProgress = Array.isArray(progressResult.data) 
                            ? progressResult.data 
                            : Object.values(progressResult.data || {});
                        
                        const userProgressData = allProgress.find(p => p.userEmail === userEmail && p.moduleId === currentModule);
                        if (userProgressData && userProgressData.videoProgress) {
                            userProgress = userProgressData.videoProgress;
                        }
                    }
                } catch (error) {
                    console.error('‚ùå ƒ∞lerleme y√ºkleme hatasƒ±:', error);
                }
            }
            
            videoList.innerHTML = '';
            
            module.videos.forEach((video, index) => {
                const isActive = video.id === currentVideoId;
                const videoProgress = userProgress[video.id] || {};
                const isCompleted = videoProgress.completed || false;
                const progressPercent = videoProgress.progressPercent || 0;
                const questionsAnswered = videoProgress.questionsAnswered || 0;
                const totalQuestions = video.questions ? video.questions.length : 0;
                
                const videoItem = document.createElement('div');
                videoItem.className = `p-3 rounded-lg cursor-pointer transition-all mb-2 ${
                    isActive 
                        ? 'bg-cyber text-white shadow-lg' 
                        : 'bg-gray-50 hover:bg-gray-100 border border-gray-200'
                }`;
                
                videoItem.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-medium text-sm truncate ${isActive ? 'text-white' : 'text-gray-900'}">${video.title || 'ƒ∞simsiz Video'}</h4>
                                ${isCompleted 
                                    ? `<i class="fas fa-check-circle ${isActive ? 'text-white' : 'text-green-500'} flex-shrink-0"></i>`
                                    : progressPercent > 0
                                    ? `<i class="fas fa-play-circle ${isActive ? 'text-white' : 'text-blue-500'} flex-shrink-0"></i>`
                                    : `<i class="far fa-circle ${isActive ? 'text-white' : 'text-gray-400'} flex-shrink-0"></i>`
                                }
                            </div>
                            ${video.duration ? `<p class="text-xs ${isActive ? 'text-blue-100' : 'text-gray-500'} mb-2">${video.duration}</p>` : ''}
                            
                            ${totalQuestions > 0 ? `
                                <div class="mt-2">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs ${isActive ? 'text-blue-100' : 'text-gray-600'}">
                                            Sorular: ${questionsAnswered}/${totalQuestions}
                                        </span>
                                        <span class="text-xs font-semibold ${isActive ? 'text-white' : 'text-gray-700'}">
                                            ${progressPercent}%
                                        </span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5 ${isActive ? 'bg-white/20' : ''}">
                                        <div class="bg-${isActive ? 'white' : 'primary'} h-1.5 rounded-full transition-all duration-300" 
                                             style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                videoItem.addEventListener('click', () => {
                    currentVideoId = video.id;
                    const videoToLoad = moduleData[currentModule]?.videos?.find(v => v.id === currentVideoId);
                    if (videoToLoad) {
                        loadVideo(videoToLoad);
                        loadVideoList(); // Refresh video list to update active state
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                
                videoList.appendChild(videoItem);
            });
        }

        function loadVideo(video) {
            if (!video) {
                showNoVideosMessage();
                return;
            }
            
            // Store current video globally
            currentVideo = video;
            
            console.log('üé¨ Video y√ºkleniyor:', video);
            
            document.getElementById('video-title').textContent = video.title;
            document.getElementById('video-description').textContent = video.description;
            
            const videoPlaceholder = document.getElementById('video-placeholder');
            
            // Check if we have a YouTube URL
            if (video.videoUrl && video.videoUrl !== '#') {
                // Extract YouTube video ID and create embed URL
                let youtubeId = video.youtubeVideoId;
                
                if (!youtubeId && video.videoUrl) {
                    // Try to extract from URL
                    const match = video.videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
                    if (match) {
                        youtubeId = match[1];
                    }
                }
                
                if (youtubeId) {
                    // Create YouTube embed iframe
                    videoPlaceholder.style.display = 'block';
                    videoPlaceholder.innerHTML = `
                        <iframe 
                            width="100%" 
                            height="100%" 
                            src="https://www.youtube.com/embed/${youtubeId}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            style="border-radius: 0.5rem;">
                        </iframe>
                    `;
                    console.log('‚úÖ YouTube video y√ºklendi:', youtubeId);
                    } else {
                    // No valid YouTube ID
                    videoPlaceholder.style.display = 'flex';
                    videoPlaceholder.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-video-slash text-6xl mb-4 opacity-75"></i>
                            <p class="text-lg">Ge√ßersiz Video URL</p>
                            <p class="text-sm opacity-75 mt-2">YouTube video ID'si √ßƒ±karƒ±lamadƒ±.</p>
                        </div>
                    `;
                    }
                } else {
                videoPlaceholder.style.display = 'flex';
                videoPlaceholder.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-video-slash text-6xl mb-4 opacity-75"></i>
                        <p class="text-lg">Video URL Mevcut Deƒüil</p>
                        <p class="text-sm opacity-75 mt-2">Bu video i√ßin hen√ºz URL tanƒ±mlanmamƒ±≈ütƒ±r.</p>
                    </div>
                `;
            }
            
            // Load questions for this video
            loadQuestions(video);
        }
        
        function loadQuestions(video) {
            const questionsContainer = document.getElementById('questions-container');
            if (!questionsContainer) return;
            
            if (!video.questions || video.questions.length === 0) {
                questionsContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-12">
                        <i class="fas fa-question-circle text-5xl mb-4 opacity-30"></i>
                        <p class="text-lg">Bu video i√ßin hen√ºz soru eklenmemi≈ü.</p>
                        <p class="text-sm mt-2">Koordinat√∂r tarafƒ±ndan sorular eklendiƒüinde burada g√∂r√ºnecektir.</p>
                    </div>
                `;
                return;
            }

            console.log(`üìù ${video.questions.length} soru y√ºkleniyor...`);
            
            questionsContainer.innerHTML = video.questions.map((q, index) => {
                const questionType = q.type || 'multiple-choice';
                const difficulty = q.difficulty || 'medium';
                
                let questionHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200 mb-6 hover:shadow-lg transition-shadow" data-question-index="${index}" data-question-type="${questionType}">
                        <div class="flex items-start mb-4">
                            <div class="flex-shrink-0 w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center font-bold mr-4">
                                ${index + 1}
                        </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h4 class="text-lg font-semibold text-gray-800">${q.question}</h4>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                        questionType === 'multiple-choice' ? 'bg-blue-100 text-blue-800' :
                                        questionType === 'open-ended' ? 'bg-green-100 text-green-800' :
                                        'bg-orange-100 text-orange-800'
                                    }">
                                        ${questionType === 'multiple-choice' ? '√áoktan Se√ßmeli' :
                                          questionType === 'open-ended' ? 'A√ßƒ±k U√ßlu' :
                                          'Bo≈üluk Doldurma'}
                                    </span>
                    </div>
                                <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${
                                    difficulty === 'easy' ? 'bg-green-100 text-green-800' : 
                                    difficulty === 'hard' ? 'bg-red-100 text-red-800' : 
                                    'bg-yellow-100 text-yellow-800'
                                }">
                                    ${difficulty === 'easy' ? 'Kolay' : difficulty === 'hard' ? 'Zor' : 'Orta'}
                                </span>
                                </div>
                            </div>
                `;
                
                // Multiple choice questions
                if (questionType === 'multiple-choice' && q.options && Array.isArray(q.options)) {
                    questionHTML += `
                        <div class="space-y-3 ml-14">
                            ${q.options.map((option, optIndex) => `
                                <div class="question-option group p-4 bg-white border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 cursor-pointer transition-all transform hover:scale-[1.02]" 
                                     data-question="${index}" 
                                     data-option="${optIndex}"
                                     onclick="selectAnswer(${index}, ${optIndex}, ${q.correctAnswer || 0})">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full border-2 border-gray-300 group-hover:border-primary flex items-center justify-center font-semibold text-gray-600 group-hover:text-primary mr-3">
                                            ${String.fromCharCode(65 + optIndex)}
                            </div>
                                        <span class="text-gray-700 group-hover:text-gray-900">${option}</span>
                        </div>
                                            </div>
                                        `).join('')}
                                    </div>
                    `;
                }
                // Open-ended questions
                else if (questionType === 'open-ended') {
                    questionHTML += `
                        <div class="ml-14">
                            <textarea id="open-ended-answer-${index}" 
                                      class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" 
                                      rows="4" 
                                      placeholder="Cevabƒ±nƒ±zƒ± buraya yazƒ±n..."></textarea>
                            <button onclick="submitOpenEndedAnswer(${index})" 
                                    class="mt-3 bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="fas fa-check mr-2"></i>Cevabƒ± G√∂nder
                            </button>
                                    </div>
                    `;
                }
                // Fill in the blank questions
                else if (questionType === 'fill-blank') {
                    // Replace ___ with input fields - limit to correctAnswers count
                    const questionParts = q.question.split('___');
                    const correctAnswers = q.correctAnswers || [];
                    const blankCount = Math.min(questionParts.length - 1, correctAnswers.length);
                    
                    questionHTML += `
                        <div class="ml-14">
                            <div class="bg-white p-4 rounded-lg border-2 border-gray-300">
                                ${questionParts.map((part, partIndex) => {
                                    let html = part;
                                    // Only create input if we have a corresponding correct answer
                                    if (partIndex < blankCount) {
                                        html += `<input type="text" 
                                                       id="fill-blank-${index}-${partIndex}" 
                                                       class="inline-block mx-2 px-3 py-2 border-2 border-primary rounded-lg focus:ring-2 focus:ring-primary/20" 
                                                       placeholder="Bo≈üluk ${partIndex + 1}" />`;
                                    } else if (partIndex < questionParts.length - 1) {
                                        // If there are more ___ than correctAnswers, show as text
                                        html += `<span class="inline-block mx-2 px-3 py-2 bg-gray-100 rounded-lg text-gray-500">[Bo≈üluk ${partIndex + 1}]</span>`;
                                    }
                                    return html;
                                }).join('')}
                                </div>
                            <p class="text-xs text-gray-500 mt-2 ml-14">${blankCount} bo≈üluk doldurmanƒ±z gerekiyor.</p>
                            <button onclick="submitFillBlankAnswer(${index})" 
                                    class="mt-3 ml-14 bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="fas fa-check mr-2"></i>Cevabƒ± G√∂nder
                            </button>
                    </div>
                `;
                }
                
                questionHTML += `
                        <div class="explanation-box mt-4 ml-14 p-4 rounded-lg border-2" style="display: none;">
                            <p class="text-sm">
                    <i class="fas fa-lightbulb mr-2"></i>
                                <strong>A√ßƒ±klama:</strong> <span class="explanation-text"></span>
                            </p>
                        </div>
                    </div>
                `;
                
                return questionHTML;
            }).join('');
        }
        
        // Submit open-ended answer
        function submitOpenEndedAnswer(questionIndex) {
            const answerTextarea = document.getElementById(`open-ended-answer-${questionIndex}`);
            const answer = answerTextarea?.value?.trim();
            
            if (!answer) {
                alert('L√ºtfen bir cevap yazƒ±n.');
                return;
            }
            
            const question = currentVideo.questions[questionIndex];
            if (!question) return;
            
            // Show feedback (for now, just show a message)
            alert('Cevabƒ±nƒ±z kaydedildi. Koordinat√∂r tarafƒ±ndan deƒüerlendirilecektir.');
            
            // Disable the textarea and button
            answerTextarea.disabled = true;
            const button = answerTextarea.nextElementSibling;
            if (button) button.disabled = true;
        }
        
        // Submit fill-in-the-blank answer
        async function submitFillBlankAnswer(questionIndex) {
            const question = currentVideo.questions[questionIndex];
            if (!question || !question.correctAnswers) return;
            
            const correctAnswers = question.correctAnswers || [];
            const questionParts = question.question.split('___');
            const blankCount = Math.min(questionParts.length - 1, correctAnswers.length);
            
            const userAnswers = [];
            let allFilled = true;
            
            // Only check inputs up to blankCount
            for (let i = 0; i < blankCount; i++) {
                const input = document.getElementById(`fill-blank-${questionIndex}-${i}`);
                if (input) {
                    const answer = input.value.trim();
                    if (answer) {
                        userAnswers.push(answer);
            } else {
                        allFilled = false;
                    }
                } else {
                    allFilled = false;
                }
            }
            
            if (!allFilled) {
                alert('L√ºtfen t√ºm bo≈üluklarƒ± doldurun.');
                return;
            }
            
            // Check answers
            let correctCount = 0;
            const wrongAnswers = [];
            
            userAnswers.forEach((answer, index) => {
                const correct = correctAnswers[index];
                if (answer.toLowerCase() === correct.toLowerCase()) {
                    correctCount++;
                            } else {
                    wrongAnswers.push({ user: answer, correct: correct });
                }
            });
            
            const isCorrect = correctCount === correctAnswers.length;
            
            // Get question div for explanation box
            const questionDiv = document.querySelector(`[data-question-index="${questionIndex}"]`);
            const explanationBox = questionDiv?.querySelector('.explanation-box');
            
            // Show feedback
            if (isCorrect) {
                if (explanationBox) {
                    explanationBox.style.display = 'block';
                    explanationBox.classList.remove('border-red-200', 'bg-red-50');
                    explanationBox.classList.add('border-green-200', 'bg-green-50');
                    explanationBox.querySelector('.explanation-text').innerHTML = '‚úÖ Doƒüru! T√ºm bo≈üluklar doƒüru dolduruldu.';
                }
                
                // Update progress
                updateVideoProgress();
            } else {
                // Show wrong answer feedback
                const wrongAnswerText = wrongAnswers.map(w => `Kullanƒ±cƒ±: "${w.user}", Doƒüru: "${w.correct}"`).join('; ');
                const correctAnswerText = correctAnswers.join(', ');
                
                if (explanationBox) {
                    explanationBox.style.display = 'block';
                    explanationBox.classList.remove('border-green-200', 'bg-green-50');
                    explanationBox.classList.add('border-red-200', 'bg-red-50');
                    explanationBox.querySelector('.explanation-text').innerHTML = 
                        `‚ùå ${correctCount}/${correctAnswers.length} bo≈üluk doƒüru. Doƒüru cevaplar: ${correctAnswerText}`;
                    
                    // Get AI recommendation for wrong answer
                    await getAIRecommendationForFillBlank(questionIndex, wrongAnswerText, correctAnswerText, explanationBox);
                }
            }
            
            // Disable inputs
            for (let i = 0; i < questionParts.length - 1; i++) {
                const input = document.getElementById(`fill-blank-${questionIndex}-${i}`);
                if (input) input.disabled = true;
            }
        }
        
        // Get AI recommendation for fill-in-the-blank wrong answers
        async function getAIRecommendationForFillBlank(questionIndex, wrongAnswerText, correctAnswerText, explanationBox) {
            try {
                if (!window.GroqAPI && !window.GeminiAPI) {
                    console.warn('‚ö†Ô∏è Groq API mevcut deƒüil');
                    return;
                }
                
                const question = currentVideo.questions[questionIndex];
                if (!question) return;
                
                const api = window.GroqAPI || window.GeminiAPI;
                if (!api || typeof api.generateVideoRecommendation !== 'function') {
                    console.error('‚ùå Groq API veya generateVideoRecommendation fonksiyonu bulunamadƒ±');
                    return;
                }
                
                // Show loading
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'mt-4 p-4 bg-white/80 rounded-lg border border-blue-300';
                loadingDiv.innerHTML = `
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        AI size √∂zel √∂neriler hazƒ±rlƒ±yor...
                    </p>
                `;
                explanationBox.appendChild(loadingDiv);
                
                // Get all modules and videos
                const modulesResult = await window.DB.load('modules');
                let allModules = [];
                if (modulesResult && modulesResult.success) {
                    if (Array.isArray(modulesResult.data)) {
                        allModules = modulesResult.data;
                    } else if (typeof modulesResult.data === 'object') {
                        allModules = Object.values(modulesResult.data);
                    }
                }
                
                const videosResult = await window.DB.load('coordinatorVideos');
                let allVideos = [];
                if (videosResult && videosResult.success) {
                    if (Array.isArray(videosResult.data)) {
                        allVideos = videosResult.data;
                    } else if (typeof videosResult.data === 'object') {
                        allVideos = Object.values(videosResult.data);
                    }
                }
                
                // Get AI recommendation
                const recommendation = await api.generateVideoRecommendation(
                    question.question,
                    wrongAnswerText,
                    correctAnswerText,
                    allModules,
                    allVideos
                );
                
                // Remove loading
                loadingDiv.remove();
                
                if (recommendation.success && recommendation.recommendedVideoId) {
                    // Show recommendation with button
                    const recommendationDiv = document.createElement('div');
                    recommendationDiv.className = 'mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-300';
                    recommendationDiv.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-robot text-purple-600 text-2xl mr-3 mt-1"></i>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 mb-3">${recommendation.feedback}</p>
                                <div class="bg-white p-3 rounded-lg border border-purple-200 mb-3">
                                    <p class="text-sm font-semibold text-purple-800 mb-1">
                                        <i class="fas fa-video mr-2"></i>${recommendation.recommendedVideoTitle || '√ñnerilen Video'}
                                    </p>
                                    <p class="text-xs text-gray-600">${recommendation.reason || ''}</p>
                                </div>
                                <button onclick="goToRecommendedVideo('${recommendation.recommendedVideoId}')" 
                                        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all transform hover:scale-105">
                                    <i class="fas fa-play-circle mr-2"></i>Bu Videoyu ƒ∞zle
                    </button>
                </div>
                        </div>
                    `;
                    explanationBox.appendChild(recommendationDiv);
                } else {
                    // Show generic feedback or error message
                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'mt-4 p-4 rounded-lg border';
                    
                    if (recommendation.error && recommendation.error.includes('Rate limit')) {
                        feedbackDiv.classList.add('bg-red-50', 'border-red-300');
                        feedbackDiv.innerHTML = `
                            <p class="text-sm text-red-700">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                <strong>API Limit A≈üƒ±ldƒ±:</strong> √áok fazla istek g√∂nderildi. L√ºtfen birka√ß dakika sonra tekrar deneyin.
                            </p>
                            <p class="text-xs text-red-600 mt-2">
                                ${recommendation.feedback || 'Bu konuyu tekrar g√∂zden ge√ßirmenizi √∂neririz.'}
                            </p>
                        `;
                } else {
                        feedbackDiv.classList.add('bg-yellow-50', 'border-yellow-300');
                        feedbackDiv.innerHTML = `
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                                ${recommendation.feedback || 'Bu konuyu tekrar g√∂zden ge√ßirmenizi √∂neririz.'}
                            </p>
                        `;
                    }
                    explanationBox.appendChild(feedbackDiv);
                }
                
            } catch (error) {
                console.error('‚ùå AI √∂neri hatasƒ±:', error);
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.remove();
                }
                
                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mt-4 p-4 bg-red-50 rounded-lg border border-red-300';
                errorDiv.innerHTML = `
                    <p class="text-sm text-red-700">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                        <strong>Hata:</strong> AI √∂nerisi alƒ±namadƒ±. L√ºtfen daha sonra tekrar deneyin.
                    </p>
                    <p class="text-xs text-red-600 mt-2">
                        ${error.message || 'Bilinmeyen bir hata olu≈ütu.'}
                    </p>
                `;
                if (explanationBox) {
                    explanationBox.appendChild(errorDiv);
                }
            }
        }
        
        // Select answer function
        function selectAnswer(questionIndex, selectedOption, correctAnswer) {
            const questionDiv = document.querySelector(`[data-question-index="${questionIndex}"]`);
            const options = questionDiv.querySelectorAll('.question-option');
            const explanationBox = questionDiv.querySelector('.explanation-box');
            const explanationText = questionDiv.querySelector('.explanation-text');
            
            // Remove previous selections
            options.forEach(opt => {
                opt.classList.remove('border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50', 'border-primary', 'bg-blue-50');
                opt.classList.add('border-gray-200', 'bg-white');
            });
            
            // Mark selected option
            const selectedDiv = questionDiv.querySelector(`[data-option="${selectedOption}"]`);
            
            if (selectedOption === correctAnswer) {
                // Correct answer
                selectedDiv.classList.remove('border-gray-200', 'bg-white');
                selectedDiv.classList.add('border-green-500', 'bg-green-50');
                explanationBox.style.display = 'block';
                explanationBox.classList.remove('border-red-200', 'bg-red-50');
                explanationBox.classList.add('border-green-200', 'bg-green-50');
                explanationText.innerHTML = '‚úÖ Doƒüru cevap! ' + (currentVideo.questions[questionIndex].explanation || 'Tebrikler!');
                
                // Update progress
                updateVideoProgress();
            } else {
                // Wrong answer
                selectedDiv.classList.remove('border-gray-200', 'bg-white');
                selectedDiv.classList.add('border-red-500', 'bg-red-50');
                
                // Show correct answer
                const correctDiv = questionDiv.querySelector(`[data-option="${correctAnswer}"]`);
                correctDiv.classList.remove('border-gray-200', 'bg-white');
                correctDiv.classList.add('border-green-500', 'bg-green-50');
                
                explanationBox.style.display = 'block';
                explanationBox.classList.remove('border-green-200', 'bg-green-50');
                explanationBox.classList.add('border-red-200', 'bg-red-50');
                explanationText.innerHTML = '‚ùå Yanlƒ±≈ü cevap. Doƒüru cevap: ' + String.fromCharCode(65 + correctAnswer) + '. ' + (currentVideo.questions[questionIndex].explanation || '');
                
                // Get AI recommendation for wrong answer
                getAIRecommendation(questionIndex, selectedOption, correctAnswer, explanationBox);
            }
        }
        
        // Get AI recommendation for wrong answers
        async function getAIRecommendation(questionIndex, selectedOption, correctAnswer, explanationBox) {
            try {
                // Wait for GroqAPI to be available
                let retries = 0;
                while (!window.GroqAPI && !window.GeminiAPI && retries < 10) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                // Show loading
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'mt-4 p-4 bg-white/80 rounded-lg border border-blue-300';
                loadingDiv.innerHTML = `
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        AI size √∂zel √∂neriler hazƒ±rlƒ±yor...
                    </p>
                `;
                explanationBox.appendChild(loadingDiv);
                
                // Get all modules and videos
                const modulesResult = await window.DB.load('modules');
                let allModules = [];
                if (modulesResult && modulesResult.success) {
                    if (Array.isArray(modulesResult.data)) {
                        allModules = modulesResult.data;
                    } else if (typeof modulesResult.data === 'object') {
                        allModules = Object.values(modulesResult.data);
                    }
                }
                
                const videosResult = await window.DB.load('coordinatorVideos');
                let allVideos = [];
                if (videosResult && videosResult.success) {
                    if (Array.isArray(videosResult.data)) {
                        allVideos = videosResult.data;
                    } else if (typeof videosResult.data === 'object') {
                        allVideos = Object.values(videosResult.data);
                    }
                }
                
                const question = currentVideo.questions[questionIndex];
                if (!question || !question.options) {
                    console.error('‚ùå Soru veya se√ßenekler bulunamadƒ±');
                    loadingDiv.remove();
                    return;
                }
                
                const wrongAnswerText = question.options[selectedOption] || 'Se√ßilen cevap';
                const correctAnswerText = question.options[correctAnswer] || 'Doƒüru cevap';
                
                console.log('ü§ñ AI √∂nerisi isteniyor:', {
                    question: question.question,
                    wrongAnswer: wrongAnswerText,
                    correctAnswer: correctAnswerText,
                    modulesCount: allModules.length,
                    videosCount: allVideos.length
                });
                
                // Get API instance
                const api = window.GroqAPI || window.GeminiAPI;
                if (!api || typeof api.generateVideoRecommendation !== 'function') {
                    console.error('‚ùå Groq API veya generateVideoRecommendation fonksiyonu bulunamadƒ±');
                    loadingDiv.remove();
                    return;
                }
                
                // Get AI recommendation
                const recommendation = await api.generateVideoRecommendation(
                    question.question,
                    wrongAnswerText,
                    correctAnswerText,
                    allModules,
                    allVideos
                );
                
                // Remove loading
                loadingDiv.remove();
                
                if (recommendation.success && recommendation.recommendedVideoId) {
                    // Show recommendation with button
                    const recommendationDiv = document.createElement('div');
                    recommendationDiv.className = 'mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-300';
                    recommendationDiv.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-robot text-purple-600 text-2xl mr-3 mt-1"></i>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 mb-3">${recommendation.feedback}</p>
                                <div class="bg-white p-3 rounded-lg border border-purple-200 mb-3">
                                    <p class="text-sm font-semibold text-purple-800 mb-1">
                                        <i class="fas fa-video mr-2"></i>${recommendation.recommendedVideoTitle}
                                    </p>
                                    <p class="text-xs text-gray-600">${recommendation.reason}</p>
                                </div>
                                <button onclick="goToRecommendedVideo('${recommendation.recommendedVideoId}')" 
                                        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all transform hover:scale-105">
                                    <i class="fas fa-play-circle mr-2"></i>Bu Videoyu ƒ∞zle
                                </button>
                            </div>
                </div>
            `;
                    explanationBox.appendChild(recommendationDiv);
                } else {
                    // Show generic feedback or error message
                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'mt-4 p-4 rounded-lg border';
                    
                    if (recommendation.error && recommendation.error.includes('Rate limit')) {
                        feedbackDiv.classList.add('bg-red-50', 'border-red-300');
                        feedbackDiv.innerHTML = `
                            <p class="text-sm text-red-700">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                <strong>API Limit A≈üƒ±ldƒ±:</strong> √áok fazla istek g√∂nderildi. L√ºtfen birka√ß dakika sonra tekrar deneyin.
                            </p>
                            <p class="text-xs text-red-600 mt-2">
                                ${recommendation.feedback || 'Bu konuyu tekrar g√∂zden ge√ßirmenizi √∂neririz.'}
                            </p>
                        `;
                    } else {
                        feedbackDiv.classList.add('bg-yellow-50', 'border-yellow-300');
                        feedbackDiv.innerHTML = `
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                                ${recommendation.feedback || 'Bu konuyu tekrar g√∂zden ge√ßirmenizi √∂neririz.'}
                            </p>
                        `;
                    }
                    explanationBox.appendChild(feedbackDiv);
                }
                
            } catch (error) {
                console.error('‚ùå AI √∂neri hatasƒ±:', error);
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.remove();
                }
                
                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mt-4 p-4 bg-red-50 rounded-lg border border-red-300';
                errorDiv.innerHTML = `
                    <p class="text-sm text-red-700">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                        <strong>Hata:</strong> AI √∂nerisi alƒ±namadƒ±. L√ºtfen daha sonra tekrar deneyin.
                    </p>
                    <p class="text-xs text-red-600 mt-2">
                        ${error.message || 'Bilinmeyen bir hata olu≈ütu.'}
                    </p>
                `;
                if (explanationBox) {
                    explanationBox.appendChild(errorDiv);
                }
            }
        }
        
        // Go to recommended video
        function goToRecommendedVideo(videoId) {
            // Find the video in current module
            const module = moduleData[currentModule];
            if (module && module.videos) {
                const video = module.videos.find(v => v.id === videoId || v.youtubeVideoId === videoId);
                if (video) {
                    currentVideoId = video.id;
                    loadVideo(video);
                    loadVideoList();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
            }
            
            // If not in current module, search in all modules
            for (const moduleId in moduleData) {
                const mod = moduleData[moduleId];
                if (mod.videos) {
                    const video = mod.videos.find(v => v.id === videoId || v.youtubeVideoId === videoId);
                    if (video) {
                        // Redirect to that module
                        window.location.href = `module-detail.html?module=${moduleId}`;
                        return;
                    }
                }
            }
            
            alert('√ñnerilen video bulunamadƒ±.');
        }
        
        // Update video progress
        async function updateVideoProgress() {
            const module = moduleData[currentModule];
            if (!module || !module.videos || !currentVideo) return;
            
            const video = module.videos.find(v => v.id === currentVideoId);
            if (!video) return;
            
            // Calculate video-specific progress
            const totalQuestions = video.questions ? video.questions.length : 0;
            let questionsAnswered = 0;
            let correctAnswers = 0;
            
            // Count answered questions (check if user has answered)
            if (video.questions) {
                video.questions.forEach((q, index) => {
                    const questionDiv = document.querySelector(`[data-question-index="${index}"]`);
                    if (questionDiv) {
                        const explanationBox = questionDiv.querySelector('.explanation-box');
                        if (explanationBox && explanationBox.style.display !== 'none') {
                            questionsAnswered++;
                            // Check if answer was correct (green background)
                            if (explanationBox.classList.contains('bg-green-50')) {
                                correctAnswers++;
                            }
                        }
                    }
                });
            }
            
            const progressPercent = totalQuestions > 0 
                ? Math.round((correctAnswers / totalQuestions) * 100) 
                : 0;
            const isCompleted = progressPercent === 100 && totalQuestions > 0;
            
            // Update video progress in module data
            if (!video.progress) video.progress = {};
            video.progress.questionsAnswered = questionsAnswered;
            video.progress.correctAnswers = correctAnswers;
            video.progress.progressPercent = progressPercent;
            video.progress.completed = isCompleted;
            
            // Calculate overall module progress
            let totalModuleProgress = 0;
            let totalModuleQuestions = 0;
            let totalModuleCorrect = 0;
            
            module.videos.forEach(v => {
                if (v.questions && v.questions.length > 0) {
                    totalModuleQuestions += v.questions.length;
                    const vProgress = v.progress || {};
                    totalModuleCorrect += (vProgress.correctAnswers || 0);
                }
            });
            
            const moduleProgress = totalModuleQuestions > 0 
                ? Math.round((totalModuleCorrect / totalModuleQuestions) * 100) 
                : 0;
            
            // Update UI
            const progressElement = document.getElementById('module-progress');
            const progressBar = document.getElementById('progress-bar');
            if (progressElement) progressElement.textContent = moduleProgress + '%';
            if (progressBar) progressBar.style.width = moduleProgress + '%';
            
            // Save progress to Firebase
            await saveProgressToFirebase(moduleProgress, video.id, {
                questionsAnswered,
                correctAnswers,
                progressPercent,
                completed: isCompleted
            });
            
            // Refresh video list to show updated progress
            await loadVideoList();
            
            console.log(`üìä Video ilerleme g√ºncellendi: ${correctAnswers}/${totalQuestions} = ${progressPercent}%`);
            console.log(`üìä Mod√ºl ilerleme: ${totalModuleCorrect}/${totalModuleQuestions} = ${moduleProgress}%`);
        }
        
        // Save progress to Firebase
        async function saveProgressToFirebase(moduleProgress, videoId, videoProgress) {
            try {
                const userEmail = localStorage.getItem('userEmail');
                if (!userEmail || !window.DB) return;
                
                // Get existing progress
                const progressResult = await window.DB.load('userProgress');
                let existingProgress = null;
                let progressId = null;
                
                if (progressResult && progressResult.success) {
                    const allProgress = Array.isArray(progressResult.data) 
                        ? progressResult.data 
                        : Object.values(progressResult.data || {});
                    
                    existingProgress = allProgress.find(p => p.userEmail === userEmail && p.moduleId === currentModule);
                    if (existingProgress && existingProgress.id) {
                        progressId = existingProgress.id;
                    }
                }
                
                // Update or create progress data
                const progressData = {
                    userEmail: userEmail,
                    moduleId: currentModule,
                    completionRate: moduleProgress,
                    videoProgress: existingProgress?.videoProgress || {},
                    lastAccessedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Update video-specific progress
                if (videoId && videoProgress) {
                    progressData.videoProgress[videoId] = {
                        questionsAnswered: videoProgress.questionsAnswered,
                        correctAnswers: videoProgress.correctAnswers,
                        progressPercent: videoProgress.progressPercent,
                        completed: videoProgress.completed,
                        updatedAt: new Date().toISOString()
                    };
                }
                
                if (progressId) {
                    // Update existing progress
                    await window.DB.save('userProgress', progressData, progressId);
                } else {
                    // Create new progress
                    await window.DB.save('userProgress', progressData);
                }
                
                console.log('‚úÖ ƒ∞lerleme Firebase\'e kaydedildi');
                
            } catch (error) {
                console.error('‚ùå ƒ∞lerleme kaydetme hatasƒ±:', error);
            }
        }

        function setupEventListeners() {
            // Previous/Next video buttons
            document.getElementById('prev-video').addEventListener('click', () => {
                const module = moduleData[currentModule];
                if (module && module.videos) {
                    const currentIndex = module.videos.findIndex(v => v.id === currentVideoId);
                    if (currentIndex > 0) {
                        currentVideoId = module.videos[currentIndex - 1].id;
                        const videoToLoad = module.videos[currentIndex - 1];
                        loadVideo(videoToLoad);
                        loadVideoList();
                    }
                }
            });

            document.getElementById('next-video').addEventListener('click', () => {
                const module = moduleData[currentModule];
                if (module && module.videos) {
                    const currentIndex = module.videos.findIndex(v => v.id === currentVideoId);
                    if (currentIndex < module.videos.length - 1) {
                        currentVideoId = module.videos[currentIndex + 1].id;
                        const videoToLoad = module.videos[currentIndex + 1];
                        loadVideo(videoToLoad);
                        loadVideoList();
                    }
                }
            });

            // Note functionality
            document.getElementById('add-note').addEventListener('click', () => {
                document.getElementById('note-modal').classList.remove('hidden');
            });

            document.getElementById('cancel-note').addEventListener('click', () => {
            document.getElementById('note-modal').classList.add('hidden');
            document.getElementById('video-note-text').value = '';
            });

            document.getElementById('save-video-note').addEventListener('click', () => {
            const noteText = document.getElementById('video-note-text').value.trim();
                if (noteText) {
                    saveVideoNote(noteText);
                    document.getElementById('note-modal').classList.add('hidden');
                    document.getElementById('video-note-text').value = '';
                }
            });

            document.getElementById('save-note').addEventListener('click', () => {
                const noteText = document.getElementById('quick-notes').value.trim();
                if (noteText) {
                    saveQuickNote(noteText);
                    document.getElementById('quick-notes').value = '';
                }
            });
        }

        function saveVideoNote(noteText) {
            const timestamp = new Date().toLocaleString('tr-TR');
            const module = moduleData[currentModule];
            const currentVideo = module?.videos?.find(v => v.id === currentVideoId);
            
            const note = {
                id: Date.now(),
                text: noteText,
                timestamp: timestamp,
                videoTitle: currentVideo?.title || 'Bilinmeyen Video',
                moduleTitle: module?.title || 'Bilinmeyen Mod√ºl'
            };

            let notes = JSON.parse(localStorage.getItem('video-notes') || '[]');
            notes.unshift(note);
            localStorage.setItem('video-notes', JSON.stringify(notes));

            displaySavedNotes();
        }

        function saveQuickNote(noteText) {
            const timestamp = new Date().toLocaleString('tr-TR');
            
            const note = {
                id: Date.now(),
                text: noteText,
                timestamp: timestamp,
                type: 'quick'
            };

            let notes = JSON.parse(localStorage.getItem('quick-notes') || '[]');
            notes.unshift(note);
            localStorage.setItem('quick-notes', JSON.stringify(notes));

            displaySavedNotes();
        }

        function loadSavedNotes() {
            displaySavedNotes();
        }

        function displaySavedNotes() {
            const savedNotesContainer = document.getElementById('saved-notes');
            const quickNotes = JSON.parse(localStorage.getItem('quick-notes') || '[]');
            const videoNotes = JSON.parse(localStorage.getItem('video-notes') || '[]');
            
            const allNotes = [...quickNotes, ...videoNotes].sort((a, b) => b.id - a.id);
            
            if (allNotes.length === 0) {
                savedNotesContainer.innerHTML = '<p class="text-gray-500 text-sm">Hen√ºz not yok</p>';
                    return;
                }
                
            savedNotesContainer.innerHTML = '';
            
            allNotes.slice(0, 3).forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'bg-gray-50 p-2 rounded text-sm';
                noteElement.innerHTML = `
                    <p class="text-gray-800">${note.text}</p>
                    <p class="text-gray-500 text-xs mt-1">${note.timestamp}</p>
                    ${note.videoTitle ? `<p class="text-blue-600 text-xs">${note.videoTitle}</p>` : ''}
                `;
                savedNotesContainer.appendChild(noteElement);
            });

            if (allNotes.length > 3) {
                const moreNotesElement = document.createElement('div');
                moreNotesElement.className = 'text-center';
                moreNotesElement.innerHTML = `
                    <a href="my-notes.html" class="text-cyber text-sm hover:underline">
                        +${allNotes.length - 3} daha fazla not g√∂r√ºnt√ºle
                    </a>
                `;
                savedNotesContainer.appendChild(moreNotesElement);
            }
        }
        
        // Logout function
        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('loginTime');
                localStorage.removeItem('userRole');
                
                console.log('üö™ √ñƒürenci √ßƒ±kƒ±≈üƒ± yapƒ±ldƒ±');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html> 




