// User Utilities - Kullanƒ±cƒ± y√∂netimi i√ßin ortak fonksiyonlar
// T√ºm √∂ƒürenci sayfalarƒ±nda kullanƒ±labilir

// Cache for user data to avoid repeated Firebase calls
let userDataCache = null;
let cacheTimestamp = null;
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

// Extract name from email
function extractNameFromEmail(email) {
    const name = email.split('@')[0];
    return name.split('.').map(part => 
        part.charAt(0).toUpperCase() + part.slice(1)
    ).join(' ');
}

// Load coordinator information from Firebase
async function loadCoordinatorInfo(userEmail) {
    try {
        console.log('üë®‚Äçüè´ Koordinat√∂r bilgileri Firebase\'den y√ºkleniyor...');
        
        // Check cache first
        const now = Date.now();
        if (userDataCache && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {
            console.log('üìã Cache\'den koordinat√∂r bilgileri alƒ±nƒ±yor');
            return userDataCache;
        }
        
        if (!window.DB) {
            throw new Error('Firebase DB hen√ºz hazƒ±r deƒüil');
        }
        
        // Load coordinator profiles from Firebase
        const coordinatorProfiles = await DB.load('coordinatorProfiles');
        console.log('üìÑ Firebase coordinator profiles y√ºklendi:', coordinatorProfiles.length);
        
        const coordinatorProfile = coordinatorProfiles.find(p => p.userEmail === userEmail);
        if (coordinatorProfile) {
            console.log('‚úÖ Koordinat√∂r profili bulundu:', coordinatorProfile);
            
            // Cache the result
            userDataCache = coordinatorProfile;
            cacheTimestamp = now;
            
            return coordinatorProfile;
        }
        
        // If not found in coordinator profiles, check regular user profiles
        const userProfiles = await DB.load('userProfiles');
        const userProfile = userProfiles.find(p => p.userEmail === userEmail);
        
        if (userProfile) {
            console.log('‚úÖ Kullanƒ±cƒ± profili bulundu:', userProfile);
            
            // Cache the result
            userDataCache = userProfile;
            cacheTimestamp = now;
            
            return userProfile;
        }
        
        // If no profile found, create a default coordinator profile
        if (userEmail.includes('koordinator') || userEmail.includes('instructor') || userEmail.includes('admin')) {
            console.log('üìù Varsayƒ±lan koordinat√∂r profili olu≈üturuluyor...');
            
            const defaultProfile = {
                userEmail: userEmail,
                firstName: extractNameFromEmail(userEmail).split(' ')[0],
                lastName: extractNameFromEmail(userEmail).split(' ')[1] || '',
                role: 'coordinator',
                title: 'Koordinat√∂r',
                department: 'Eƒüitim Koordinasyonu',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Save to Firebase
            await DB.save('coordinatorProfiles', defaultProfile);
            console.log('‚úÖ Varsayƒ±lan koordinat√∂r profili kaydedildi');
            
            // Cache the result
            userDataCache = defaultProfile;
            cacheTimestamp = now;
            
            return defaultProfile;
        }
        
        return null;
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Koordinat√∂r bilgileri y√ºklenemedi:', error);
        return null;
    }
}

// Load user information from localStorage or Firebase
async function loadUserInfo() {
    let userEmail = localStorage.getItem('userEmail');
    
    // Eƒüer localStorage'da kullanƒ±cƒ± bilgisi yoksa, varsayƒ±lan deƒüerler ayarla
    if (!userEmail) {
        console.warn('‚ö†Ô∏è localStorage\'da kullanƒ±cƒ± bilgisi yok, varsayƒ±lan deƒüerler ayarlanƒ±yor...');
        userEmail = 'ahmet.yilmaz@meb.gov.tr';
        localStorage.setItem('userEmail', userEmail);
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userName', 'Ahmet Yƒ±lmaz');
        console.log('‚úÖ Varsayƒ±lan kullanƒ±cƒ± bilgileri ayarlandƒ±:', userEmail);
    }
    
    console.log('üë§ Kullanƒ±cƒ± bilgileri y√ºkleniyor:', userEmail);
    
    try {
        // Check if user is coordinator
        const isCoordinator = userEmail.includes('koordinator') || userEmail.includes('instructor') || userEmail.includes('admin');
        
        if (isCoordinator) {
            // Load coordinator information from Firebase
            const coordinatorInfo = await loadCoordinatorInfo(userEmail);
            
            if (coordinatorInfo) {
                const fullName = `${coordinatorInfo.firstName || ''} ${coordinatorInfo.lastName || ''}`.trim();
                const displayName = coordinatorInfo.title ? 
                    `${coordinatorInfo.title} ${fullName}` : 
                    `Koordinat√∂r ${fullName || extractNameFromEmail(userEmail)}`;
                
                updateUserDisplay(displayName, userEmail);
                return;
            }
        }
        
        // For regular users or if coordinator info not found
        if (window.DB) {
            // Try to load from Firebase first
            const profiles = await DB.load('userProfiles');
            console.log('üìÑ Firebase profiles y√ºklendi:', profiles.length);
            
            const userProfile = profiles.find(p => p.userEmail === userEmail);
            if (userProfile) {
                console.log('‚úÖ Kullanƒ±cƒ± profili bulundu:', userProfile);
                const fullName = `${userProfile.firstName || ''} ${userProfile.lastName || ''}`.trim();
                const displayName = fullName || extractNameFromEmail(userEmail);
                updateUserDisplay(displayName, userEmail);
                return;
            }
        }
        
        // Fallback: extract name from email
        const displayName = extractNameFromEmail(userEmail);
        console.log('üìß E-postadan isim √ßƒ±karƒ±ldƒ±:', displayName);
        updateUserDisplay(displayName, userEmail);
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Kullanƒ±cƒ± profili y√ºklenemedi:', error);
        // Fallback: extract name from email
        const displayName = extractNameFromEmail(userEmail);
        updateUserDisplay(displayName, userEmail);
    }
}

// Update user display in UI
function updateUserDisplay(name, email) {
    console.log(`üîÑ UI g√ºncelleniyor: ${name} (${email})`);
    
    // Update desktop sidebar
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    
    if (userName) {
        userName.textContent = name;
        console.log('‚úÖ Desktop name g√ºncellendi:', name);
    }
    if (userEmail) {
        // user-email elementini bo≈ü bƒ±rakƒ±yoruz
        userEmail.textContent = '';
        console.log('‚úÖ Desktop email bo≈ü bƒ±rakƒ±ldƒ±');
    }

    // Update mobile sidebar
    const mobileUserName = document.getElementById('mobile-user-name');
    const mobileUserEmail = document.getElementById('mobile-user-email');
    
    if (mobileUserName) {
        mobileUserName.textContent = name;
        console.log('‚úÖ Mobile name g√ºncellendi:', name);
    }
    if (mobileUserEmail) {
        // mobile user-email elementini de bo≈ü bƒ±rakƒ±yoruz
        mobileUserEmail.textContent = '';
        console.log('‚úÖ Mobile email bo≈ü bƒ±rakƒ±ldƒ±');
    }

    // Update header user name
    const headerUserName = document.getElementById('header-user-name');
    if (headerUserName) {
        headerUserName.textContent = name;
        console.log('‚úÖ Header name g√ºncellendi:', name);
    }

    // Update profile page specific elements
    const profileName = document.getElementById('profile-name');
    const profileEmail = document.getElementById('profile-email');
    
    if (profileName) {
        profileName.textContent = name;
        console.log('‚úÖ Profile name g√ºncellendi:', name);
    }
    if (profileEmail) {
        profileEmail.textContent = email;
        console.log('‚úÖ Profile email g√ºncellendi:', email);
    }

    // Update instructor/coordinator specific elements
    const instructorName = document.getElementById('instructor-name');
    const instructorEmail = document.getElementById('instructor-email');
    
    if (instructorName) {
        instructorName.textContent = name;
        console.log('‚úÖ Instructor name g√ºncellendi:', name);
    }
    if (instructorEmail) {
        instructorEmail.textContent = '';
        console.log('‚úÖ Instructor email bo≈ü bƒ±rakƒ±ldƒ±');
    }

    // Update mobile instructor elements
    const mobileInstructorName = document.getElementById('mobile-instructor-name');
    const mobileInstructorEmail = document.getElementById('mobile-instructor-email');
    
    if (mobileInstructorName) {
        mobileInstructorName.textContent = name;
        console.log('‚úÖ Mobile instructor name g√ºncellendi:', name);
    }
    if (mobileInstructorEmail) {
        mobileInstructorEmail.textContent = '';
        console.log('‚úÖ Mobile instructor email bo≈ü bƒ±rakƒ±ldƒ±');
    }
}

// Wait for Firebase DB to be ready with timeout
async function waitForFirebaseDB() {
    return new Promise((resolve, reject) => {
        const timeout = 10000; // 10 seconds timeout
        const startTime = Date.now();
        
        const checkDB = () => {
            if (window.DB && window.DB.isFirebaseReady !== false) {
                console.log('‚úÖ Firebase Production DB hazƒ±r!');
                resolve();
            } else if (Date.now() - startTime > timeout) {
                console.warn('‚ö†Ô∏è Firebase DB timeout, devam ediliyor...');
                resolve(); // Continue without Firebase
            } else {
                console.log('‚è≥ Firebase Production DB bekleniyor...');
                setTimeout(checkDB, 100); // Check more frequently
            }
        };
        checkDB();
    });
}

// Initialize user info on page load with performance optimizations
async function initializeUserInfo() {
    console.log('üöÄ Kullanƒ±cƒ± bilgileri ba≈ülatƒ±lƒ±yor...');
    
    // Show loading indicator
    showLoadingIndicator();
    
    try {
        // Check if user is logged in - eƒüer deƒüilse varsayƒ±lan ayarla
        let isLoggedIn = localStorage.getItem('isLoggedIn');
        if (isLoggedIn !== 'true') {
            console.log('‚ö†Ô∏è Oturum a√ßƒ±lmamƒ±≈ü, varsayƒ±lan oturum ayarlanƒ±yor...');
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userEmail', 'ahmet.yilmaz@meb.gov.tr');
            localStorage.setItem('userName', 'Ahmet Yƒ±lmaz');
            isLoggedIn = 'true';
        }
        
        const userEmail = localStorage.getItem('userEmail');
        console.log('‚úÖ Oturum a√ßƒ±k:', userEmail);
        
        // Load user info immediately with cached data if available
        const cachedName = localStorage.getItem('cachedUserName');
        if (cachedName) {
            updateUserDisplay(cachedName, userEmail);
            console.log('‚ö° Cached kullanƒ±cƒ± bilgileri g√∂sterildi');
        }
        
        // Wait for Firebase to be ready (with timeout)
        await waitForFirebaseDB();
        
        // Load user information from Firebase
        await loadUserInfo();
        
        console.log('üéâ Kullanƒ±cƒ± bilgileri ba≈ülatma tamamlandƒ±');
        return true;
        
    } catch (error) {
        console.error('‚ùå Kullanƒ±cƒ± bilgileri ba≈ülatma hatasƒ±:', error);
        
        // Fallback: use email-based name
        const userEmail = localStorage.getItem('userEmail') || 'user@example.com';
        const fallbackName = extractNameFromEmail(userEmail);
        updateUserDisplay(fallbackName, userEmail);
        
        return true; // Continue even with errors
    } finally {
        // Hide loading indicator
        hideLoadingIndicator();
    }
}

// Show loading indicator
function showLoadingIndicator() {
    const indicators = document.querySelectorAll('.user-loading');
    indicators.forEach(indicator => {
        if (indicator) indicator.style.display = 'block';
    });
}

// Hide loading indicator
function hideLoadingIndicator() {
    const indicators = document.querySelectorAll('.user-loading');
    indicators.forEach(indicator => {
        if (indicator) indicator.style.display = 'none';
    });
}

// Clear user data cache
function clearUserCache() {
    userDataCache = null;
    cacheTimestamp = null;
    localStorage.removeItem('cachedUserName');
}

// Export functions for use in other files
if (typeof window !== 'undefined') {
    window.UserUtils = {
        loadUserInfo,
        loadCoordinatorInfo,
        updateUserDisplay,
        waitForFirebaseDB,
        initializeUserInfo,
        extractNameFromEmail,
        clearUserCache
    };
    
    // Listen for Firebase ready event
    window.addEventListener('firebaseReady', (event) => {
        console.log('üî• Firebase ready event alƒ±ndƒ±:', event.detail);
        
        // If Firebase is ready and user info hasn't been loaded yet, load it
        if (event.detail.ready && !userDataCache) {
            console.log('‚ö° Firebase hazƒ±r, kullanƒ±cƒ± bilgileri y√ºkleniyor...');
            loadUserInfo().catch(error => {
                console.warn('‚ö†Ô∏è Firebase ready sonrasƒ± kullanƒ±cƒ± bilgisi y√ºklenemedi:', error);
            });
        }
    });
} 